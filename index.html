<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Singh Automation - AI Contract Intelligence</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root { 
            --green: #9ACD32; --green-dark: #7BA428;
            --dark: #0a0a0a; --card: #141414; --card-hover: #1a1a1a; --border: #2a2a2a;
            --gray: #888; --blue: #3b82f6; --purple: #8b5cf6; --orange: #f59e0b; --red: #ef4444;
        }
        body { font-family: 'Inter', sans-serif; background: var(--dark); color: #fff; min-height: 100vh; }
        
        .header { 
            background: linear-gradient(180deg, #111 0%, var(--dark) 100%);
            padding: 0.75rem 1.5rem; display: flex; justify-content: space-between; align-items: center; 
            border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100;
        }
        .logo { display: flex; align-items: center; gap: 0.6rem; }
        .logo-icon { width: 38px; height: 38px; background: linear-gradient(135deg, var(--green), var(--green-dark)); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 700; color: #000; }
        .logo-text { font-size: 1.2rem; font-weight: 700; }
        .logo-text span { color: var(--green); }
        
        .nav { display: flex; gap: 0.25rem; background: var(--card); padding: 0.25rem; border-radius: 8px; }
        .nav-btn { padding: 0.5rem 1rem; background: transparent; border: none; border-radius: 6px; color: var(--gray); cursor: pointer; font-weight: 500; font-size: 0.8rem; transition: all 0.2s; }
        .nav-btn:hover { color: #fff; background: rgba(255,255,255,0.05); }
        .nav-btn.active { background: var(--green); color: #000; }
        
        .status { display: flex; align-items: center; gap: 0.4rem; font-size: 0.75rem; color: var(--gray); }
        .status-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--gray); }
        .status-dot.live { background: var(--green); box-shadow: 0 0 8px var(--green); }
        
        .btn { padding: 0.5rem 1rem; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.8rem; transition: all 0.15s; display: inline-flex; align-items: center; gap: 0.3rem; }
        .btn-primary { background: var(--green); color: #000; }
        .btn-primary:hover { background: var(--green-dark); }
        .btn-secondary { background: var(--card); color: #fff; border: 1px solid var(--border); }
        .btn-secondary:hover { background: var(--card-hover); }
        .btn-sm { padding: 0.35rem 0.7rem; font-size: 0.75rem; }
        .btn-go { background: var(--green); color: #000; }
        .btn-review { background: var(--orange); color: #000; }
        .btn-nogo { background: var(--red); color: #fff; }
        .btn-proposal { background: linear-gradient(135deg, var(--green), var(--green-dark)); color: #000; }
        .btn-proposal:hover { box-shadow: 0 0 12px rgba(154, 205, 50, 0.4); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .config-bar { background: rgba(154,205,50,0.03); border-bottom: 1px solid var(--border); padding: 0.6rem 1.5rem; display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap; }
        .config-bar label { font-size: 0.75rem; color: var(--green); font-weight: 500; }
        .config-bar input { padding: 0.4rem 0.6rem; background: var(--card); border: 1px solid var(--border); border-radius: 4px; color: #fff; font-size: 0.8rem; }
        .config-bar input:focus { outline: none; border-color: var(--green); }
        
        .stats-bar { display: grid; grid-template-columns: repeat(6, 1fr); gap: 0.75rem; padding: 1rem 1.5rem; background: #0d0d0d; }
        .stat { background: var(--card); padding: 0.75rem; border-radius: 8px; text-align: center; border: 1px solid var(--border); }
        .stat-value { font-size: 1.5rem; font-weight: 700; color: var(--green); }
        .stat-label { font-size: 0.65rem; color: var(--gray); text-transform: uppercase; }
        
        .main { display: grid; grid-template-columns: 180px 1fr 240px; gap: 1rem; padding: 1rem 1.5rem; min-height: calc(100vh - 180px); }
        .main-full { grid-template-columns: 1fr; max-width: 1000px; margin: 0 auto; }
        
        .panel { background: var(--card); border-radius: 8px; padding: 0.75rem; border: 1px solid var(--border); }
        .panel-title { font-size: 0.7rem; color: var(--green); margin-bottom: 0.6rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; }
        
        .sidebar { display: flex; flex-direction: column; gap: 0.75rem; }
        .source-item { display: flex; justify-content: space-between; padding: 0.4rem 0; border-bottom: 1px solid #1a1a1a; font-size: 0.8rem; }
        .badge { font-size: 0.55rem; padding: 0.15rem 0.4rem; border-radius: 3px; font-weight: 600; }
        .badge-live { background: var(--green); color: #000; }
        .cert-badge { display: inline-block; background: #1a1a1a; padding: 0.2rem 0.4rem; border-radius: 3px; font-size: 0.6rem; margin: 0.1rem; }
        
        .tabs { display: flex; gap: 0.3rem; flex-wrap: wrap; }
        .tab { padding: 0.4rem 0.8rem; background: var(--card); border: 1px solid var(--border); border-radius: 6px; color: #aaa; cursor: pointer; font-size: 0.75rem; font-weight: 500; transition: all 0.15s; }
        .tab:hover { background: var(--card-hover); color: #fff; }
        .tab.active { background: var(--green); color: #000; border-color: var(--green); }
        
        .filter-bar { display: flex; gap: 0.4rem; flex-wrap: wrap; align-items: center; background: var(--card); padding: 0.5rem; border-radius: 6px; border: 1px solid var(--border); }
        .search-input { flex: 1; min-width: 150px; padding: 0.4rem 0.75rem; background: #0a0a0a; border: 1px solid var(--border); border-radius: 4px; color: #fff; font-size: 0.8rem; }
        .filter-pill { padding: 0.3rem 0.6rem; background: #1a1a1a; border: none; border-radius: 12px; color: #aaa; cursor: pointer; font-size: 0.7rem; }
        .filter-pill:hover { background: #222; color: #fff; }
        .filter-pill.active { background: var(--green); color: #000; }
        
        .opp-list { display: flex; flex-direction: column; gap: 0.5rem; max-height: calc(100vh - 350px); overflow-y: auto; }
        .opp-list::-webkit-scrollbar { width: 4px; }
        .opp-list::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }
        
        .opp-card { background: var(--card); border-radius: 8px; padding: 0.75rem; border: 1px solid var(--border); position: relative; cursor: pointer; transition: all 0.15s; }
        .opp-card:hover { background: var(--card-hover); border-color: #333; }
        .opp-card.qualified { border-left: 3px solid var(--green); }
        .opp-card.not-qualified { opacity: 0.5; border-left: 3px solid var(--red); }
        .opp-card.review { border-left: 3px solid var(--orange); }
        .opp-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.4rem; }
        .opp-title { font-size: 0.85rem; font-weight: 600; flex: 1; margin-right: 3.5rem; line-height: 1.3; }
        .opp-type { font-size: 0.55rem; padding: 0.15rem 0.4rem; border-radius: 3px; text-transform: uppercase; font-weight: 600; }
        .opp-type.contract { background: var(--blue); }
        .opp-type.sbir { background: var(--purple); }
        .opp-type.state { background: var(--orange); }
        .opp-meta { display: flex; gap: 0.75rem; font-size: 0.65rem; color: var(--gray); margin-bottom: 0.4rem; flex-wrap: wrap; }
        .opp-desc { font-size: 0.7rem; color: #777; margin-bottom: 0.4rem; line-height: 1.4; }
        .opp-tags { display: flex; gap: 0.2rem; flex-wrap: wrap; }
        .tag { font-size: 0.55rem; padding: 0.1rem 0.35rem; border-radius: 3px; background: rgba(154,205,50,0.1); color: var(--green); }
        .tag-nq { background: rgba(239,68,68,0.1); color: #f87171; }
        .match-score { position: absolute; top: 0.75rem; right: 0.75rem; background: var(--green); color: #000; padding: 0.15rem 0.4rem; border-radius: 4px; font-weight: 700; font-size: 0.75rem; }
        .match-score.medium { background: var(--orange); }
        .match-score.low { background: #333; color: #888; }
        
        .right-panel { display: flex; flex-direction: column; gap: 0.75rem; }
        .alert-item { display: flex; align-items: center; gap: 0.4rem; padding: 0.4rem; background: #1a1a1a; border-radius: 4px; font-size: 0.7rem; margin-bottom: 0.3rem; cursor: pointer; }
        .alert-item:hover { background: #222; }
        .alert-dot { width: 6px; height: 6px; border-radius: 50%; }
        .alert-dot.red { background: var(--red); }
        .alert-dot.green { background: var(--green); }
        .alert-dot.orange { background: var(--orange); }
        
        /* Modal */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 1000; align-items: flex-start; justify-content: center; padding: 2rem; overflow-y: auto; }
        .modal-overlay.active { display: flex; }
        .modal { background: var(--card); border-radius: 12px; max-width: 900px; width: 100%; border: 1px solid var(--border); }
        .modal-header { padding: 1rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2 { font-size: 1rem; font-weight: 600; }
        .modal-close { background: none; border: none; color: var(--gray); font-size: 1.25rem; cursor: pointer; }
        .modal-body { padding: 1rem; max-height: 70vh; overflow-y: auto; }
        .modal-footer { padding: 1rem; border-top: 1px solid var(--border); display: flex; gap: 0.5rem; flex-wrap: wrap; }
        
        .modal-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; margin-bottom: 1rem; }
        .modal-item { background: #1a1a1a; padding: 0.6rem; border-radius: 6px; }
        .modal-item label { font-size: 0.6rem; color: var(--gray); display: block; text-transform: uppercase; margin-bottom: 0.2rem; }
        .modal-item strong { font-size: 0.85rem; }
        
        .eligibility-banner { padding: 0.75rem; border-radius: 8px; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.6rem; }
        .eligibility-banner.go { background: rgba(154,205,50,0.1); border: 1px solid var(--green); }
        .eligibility-banner.review { background: rgba(245,158,11,0.1); border: 1px solid var(--orange); }
        .eligibility-banner.nogo { background: rgba(239,68,68,0.1); border: 1px solid var(--red); }
        .eligibility-banner .icon { font-size: 1.5rem; }
        .eligibility-banner .text strong { display: block; font-size: 1rem; }
        .eligibility-banner.go strong { color: var(--green); }
        .eligibility-banner.review strong { color: var(--orange); }
        .eligibility-banner.nogo strong { color: var(--red); }
        .eligibility-banner .text p { font-size: 0.75rem; color: var(--gray); margin: 0.2rem 0 0; }
        
        /* Validation Results */
        .validation-section { background: #0d0d0d; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; }
        .validation-section h3 { font-size: 0.85rem; color: var(--green); margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.4rem; }
        .check-list { display: flex; flex-direction: column; gap: 0.5rem; }
        .check-item { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: var(--card); border-radius: 6px; }
        .check-status { width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; flex-shrink: 0; }
        .check-status.pass { background: rgba(154,205,50,0.2); color: var(--green); }
        .check-status.fail { background: rgba(239,68,68,0.2); color: var(--red); }
        .check-status.warn { background: rgba(245,158,11,0.2); color: var(--orange); }
        .check-status.review { background: rgba(59,130,246,0.2); color: var(--blue); }
        .check-content { flex: 1; }
        .check-content strong { font-size: 0.8rem; display: block; }
        .check-content span { font-size: 0.7rem; color: var(--gray); }
        
        /* Context Summary & Compliance Checklist */
        .context-summary { background: rgba(59,130,246,0.1); border: 1px solid rgba(59,130,246,0.3); border-radius: 6px; padding: 0.75rem; margin-bottom: 1rem; font-size: 0.8rem; }
        .context-summary strong { color: var(--blue); }
        .compliance-checklist { background: rgba(154,205,50,0.05); border: 1px solid rgba(154,205,50,0.2); border-radius: 6px; padding: 1rem; margin-top: 1.5rem; }
        .compliance-checklist h3 { color: var(--green); font-size: 0.9rem; margin-bottom: 0.75rem; }
        .compliance-checklist ul { list-style: none; padding: 0; margin: 0; }
        .compliance-checklist li { padding: 0.3rem 0; font-size: 0.8rem; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .compliance-checklist li:last-child { border-bottom: none; }
        .gen-info { margin-top: 1rem; padding-top: 0.75rem; border-top: 1px solid var(--border); text-align: center; color: var(--gray); }
        
        .timeline-item { display: flex; gap: 0.75rem; padding: 0.5rem 0; border-left: 2px solid var(--border); margin-left: 0.5rem; padding-left: 1rem; position: relative; }
        .timeline-item::before { content: ''; position: absolute; left: -5px; top: 0.65rem; width: 8px; height: 8px; border-radius: 50%; background: var(--border); }
        .timeline-item.critical::before { background: var(--green); }
        .timeline-date { font-size: 0.7rem; color: var(--green); font-weight: 600; min-width: 80px; }
        .timeline-task { font-size: 0.8rem; }
        .timeline-days { font-size: 0.65rem; color: var(--gray); }
        
        .next-steps { display: flex; flex-direction: column; gap: 0.3rem; }
        .next-step { display: flex; align-items: center; gap: 0.5rem; font-size: 0.8rem; padding: 0.4rem; background: var(--card); border-radius: 4px; }
        .next-step::before { content: '‚Üí'; color: var(--green); }
        
        /* Page sections */
        .page { display: none; }
        .page.active { display: block; }
        
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; font-size: 0.75rem; color: var(--green); margin-bottom: 0.4rem; font-weight: 500; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.6rem; background: #1a1a1a; border: 1px solid var(--border); border-radius: 6px; color: #fff; font-size: 0.85rem; }
        .form-group input:focus { outline: none; border-color: var(--green); }
        .form-hint { font-size: 0.65rem; color: var(--gray); margin-top: 0.3rem; }
        .form-hint a { color: var(--green); }
        
        .loading-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 2000; align-items: center; justify-content: center; flex-direction: column; gap: 0.75rem; }
        .loading-overlay.active { display: flex; }
        .spinner { width: 40px; height: 40px; border: 3px solid #333; border-top-color: var(--green); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        
        /* Score breakdown tooltip */
        .score-badge { position: relative; cursor: help; }
        .score-tooltip { 
            display: none; position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); 
            background: #1a1a1a; border: 1px solid var(--border); border-radius: 6px; padding: 0.5rem;
            min-width: 180px; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        }
        .score-badge:hover .score-tooltip { display: block; }
        .score-tooltip-title { font-size: 0.65rem; color: var(--green); margin-bottom: 0.3rem; font-weight: 600; }
        .score-tooltip-row { display: flex; justify-content: space-between; font-size: 0.7rem; padding: 0.15rem 0; }
        .score-tooltip-row span:first-child { color: var(--gray); }
        .score-tooltip-row span:last-child { color: var(--green); font-weight: 600; }
        
        .log-panel { background: #0a0a0a; border-radius: 4px; padding: 0.4rem; font-family: monospace; font-size: 0.6rem; max-height: 60px; overflow-y: auto; }
        .log-entry { padding: 0.1rem 0; color: #555; }
        .log-entry.success { color: var(--green); }
        .log-entry.error { color: var(--red); }
        .log-entry.info { color: var(--blue); }
        
        @media (max-width: 1000px) { .main { grid-template-columns: 1fr; } .sidebar, .right-panel { display: none; } .stats-bar { grid-template-columns: repeat(3, 1fr); } }
        
        /* Quote Request Button & Modal */
        .btn-quote { background: linear-gradient(135deg, #4a90d9 0%, #357abd 100%); color: white; }
        .btn-quote:hover { box-shadow: 0 4px 12px rgba(74,144,217,0.4); transform: translateY(-1px); }
        
        /* Quote Modal Styles */
        #quoteRequestModal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.85);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            overflow-y: auto;
        }
        .quote-modal {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .quote-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            background: rgba(154,205,50,0.05);
        }
        .quote-modal-body {
            padding: 1.5rem;
        }
        .quote-modal-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border);
            background: rgba(0,0,0,0.2);
        }
        .quote-warning {
            background: rgba(245,158,11,0.1);
            border: 1px solid var(--orange);
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 1rem;
        }
        .quote-section {
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .quote-items-table {
            width: 100%;
            border-collapse: collapse;
        }
        .quote-items-table th,
        .quote-items-table td {
            padding: 0.5rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
            font-size: 0.8rem;
        }
        .quote-items-table th {
            color: var(--gray);
            font-weight: 500;
        }
        .quote-type-badge {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        .quote-type-badge.dist { background: rgba(16,185,129,0.2); color: #34d399; }
        .quote-type-badge.integ { background: rgba(139,92,246,0.2); color: #a78bfa; }
        .quote-type-badge.service { background: rgba(59,130,246,0.2); color: #60a5fa; }
        .quote-type-badge.unclear { background: rgba(100,100,100,0.2); color: #888; }
        .quote-warning { background: rgba(245,158,11,0.1); border: 1px solid var(--orange); border-radius: 8px; padding: 0.75rem; margin-bottom: 1rem; }
        .quote-section { background: #1a1a1a; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; }
        .quote-items-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        .quote-items-table th, .quote-items-table td { padding: 0.5rem; text-align: left; border-bottom: 1px solid #252525; }
        .quote-items-table th { color: var(--gray); font-size: 0.7rem; }
        .quote-type-badge { padding: 0.125rem 0.5rem; border-radius: 4px; font-size: 0.7rem; }
        .quote-type-badge.dist { background: #064e3b; color: #34d399; }
        .quote-type-badge.integ { background: #1e3a5f; color: #60a5fa; }
        .quote-type-badge.service { background: #3f3f46; color: #a1a1aa; }
        .quote-type-badge.unclear { background: #451a03; color: #fbbf24; }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo">
            <div class="logo-icon">SA</div>
            <div class="logo-text"><span>SINGH</span> AUTO</div>
        </div>
        <nav class="nav">
            <button class="nav-btn active" data-page="scanner">üì° Scanner</button>
            <button class="nav-btn" data-page="purchasing">üõí Purchasing</button>
            <button class="nav-btn" data-page="subcontracting">üéØ Subcontracting</button>
            <button class="nav-btn" data-page="pipeline">üìä Pipeline</button>
            <button class="nav-btn" data-page="agent">ü§ñ AI Agent</button>
        </nav>
        <div style="display: flex; align-items: center; gap: 0.75rem;">
            <div class="status"><span class="status-dot" id="statusDot"></span><span id="statusText">Ready</span></div>
            <button class="btn btn-primary btn-sm" onclick="scanAll()">üîÑ Scan</button>
            <button class="btn btn-secondary btn-sm" onclick="loadDemoData()" title="Load sample opportunities for testing">üìã Demo</button>
        </div>
    </header>

    <div class="config-bar">
        <label>API:</label>
        <input type="text" id="apiUrl" value="https://singh-automation.vercel.app/api/sam" style="width: 300px;">
        <label>üîë Claude:</label>
        <input type="password" id="claudeKey" placeholder="sk-ant-..." style="width: 180px;">
    </div>

    <!-- SCANNER PAGE -->
    <div class="page active" id="page-scanner">
        <div class="stats-bar">
            <div class="stat"><div class="stat-value" id="statLive">0</div><div class="stat-label">Live</div></div>
            <div class="stat"><div class="stat-value" id="statTotal">0</div><div class="stat-label">Total</div></div>
            <div class="stat"><div class="stat-value" id="statQualified">0</div><div class="stat-label">Qualified</div></div>
            <div class="stat"><div class="stat-value" id="statUrgent">0</div><div class="stat-label">Urgent</div></div>
            <div class="stat"><div class="stat-value" id="statValue">$0</div><div class="stat-label">Value</div></div>
            <div class="stat"><div class="stat-value" id="statMatch">0%</div><div class="stat-label">Avg Match</div></div>
        </div>
        
        <div class="main">
            <div class="sidebar">
                <div class="panel">
                    <div class="panel-title">üèõÔ∏è Sources</div>
                    <div class="source-item"><span>SAM.gov</span><span class="badge badge-live">LIVE</span></div>
                    <div class="source-item"><span>SBIR/STTR</span><span class="badge badge-live">LIVE</span></div>
                    <div class="source-item"><span>DIBBS</span><span class="badge badge-live">LIVE</span></div>
                    <div class="source-item"><span>CA eProcure</span><span class="badge badge-live">LIVE</span></div>
                    <div class="source-item"><span>MI SIGMA</span><span class="badge badge-live">LIVE</span></div>
                    <div class="source-item"><span>TX SmartBuy</span><span class="badge badge-live">LIVE</span></div>
                    <div class="source-item"><span>Forecasts</span><span class="badge" style="background: #555;">BETA</span></div>
                </div>
                <div class="panel">
                    <div class="panel-title">üìß Email Alerts</div>
                    <input type="email" id="alertEmail" placeholder="your@email.com" style="width: 100%; padding: 0.5rem; margin-bottom: 0.5rem; background: var(--darker); border: 1px solid var(--border); border-radius: 4px; color: var(--light);">
                    <select id="alertFreq" style="width: 100%; padding: 0.5rem; margin-bottom: 0.5rem; background: var(--darker); border: 1px solid var(--border); border-radius: 4px; color: var(--light);">
                        <option value="daily">Daily Digest</option>
                        <option value="weekly">Weekly Summary</option>
                        <option value="instant">Instant (New Opps)</option>
                    </select>
                    <button class="btn btn-primary btn-sm" onclick="subscribeAlerts()" style="width: 100%;">üîî Subscribe</button>
                </div>
                <div class="panel">
                    <div class="panel-title">üèÜ Certs</div>
                    <span class="cert-badge">FANUC ASI</span>
                    <span class="cert-badge">UR CSP</span>
                    <span class="cert-badge">MBE</span>
                    <span class="cert-badge">WBENC</span>
                </div>
            </div>
            
            <div class="content" style="display: flex; flex-direction: column; gap: 0.75rem;">
                <div class="tabs" id="tabsContainer"></div>
                <div class="filter-bar">
                    <input type="text" class="search-input" placeholder="üîç Search..." id="searchInput">
                    <button class="filter-pill active" data-filter="all">All</button>
                    <button class="filter-pill" data-filter="contract">Federal</button>
                    <button class="filter-pill" data-filter="sbir">SBIR</button>
                    <button class="filter-pill" data-filter="state">State</button>
                    <button class="filter-pill" data-filter="dibbs">DIBBS</button>
                    <button class="filter-pill" data-filter="forecast">Forecast</button>
                </div>
                <div class="opp-list" id="oppList">
                    <div style="text-align: center; padding: 2rem; color: var(--gray);">
                        <div style="font-size: 2rem; opacity: 0.4;">üì°</div>
                        <h3 style="margin: 0.5rem 0;">Ready to Scan</h3>
                        <p style="font-size: 0.8rem;">Click Scan to load opportunities</p>
                    </div>
                </div>
                <div class="log-panel" id="logPanel"></div>
            </div>
            
            <div class="right-panel">
                <div class="panel">
                    <div class="panel-title">‚ö° Quick Actions</div>
                    <div id="qualifiedList"></div>
                </div>
                <div class="panel">
                    <div class="panel-title">üìã Pipeline</div>
                    <div id="pipelineSummary">
                        <div style="font-size: 0.75rem; color: var(--gray);">
                            <div>üü¢ GO: <span id="pipelineGo">0</span></div>
                            <div>üü° Review: <span id="pipelineReview">0</span></div>
                            <div>üî¥ No-Go: <span id="pipelineNoGo">0</span></div>
                        </div>
                    </div>
                </div>
                <div class="panel">
                    <div class="panel-title">üéØ Revenue Target</div>
                    <div style="font-size: 0.7rem; margin-bottom: 0.5rem;">
                        <label style="color: var(--gray);">Annual Goal</label>
                        <input type="text" id="revenueGoal" value="500000" style="width: 100%; padding: 0.3rem; background: #0a0a0a; border: 1px solid var(--border); border-radius: 4px; color: #fff; font-size: 0.75rem;" onchange="updateRevenueCalculator()">
                    </div>
                    <div style="font-size: 0.7rem; margin-bottom: 0.5rem;">
                        <label style="color: var(--gray);">Win Rate (%)</label>
                        <input type="number" id="winRate" value="25" min="1" max="100" style="width: 100%; padding: 0.3rem; background: #0a0a0a; border: 1px solid var(--border); border-radius: 4px; color: #fff; font-size: 0.75rem;" onchange="updateRevenueCalculator()">
                    </div>
                    <div id="revenueCalcResult" style="background: #0a0a0a; padding: 0.5rem; border-radius: 4px; margin-top: 0.5rem;">
                        <div style="font-size: 0.65rem; color: var(--gray);">Pipeline Needed:</div>
                        <div id="pipelineNeeded" style="font-size: 1rem; font-weight: 700; color: var(--green);">$2M</div>
                        <div style="font-size: 0.65rem; color: var(--gray); margin-top: 0.3rem;">Current GO Pipeline:</div>
                        <div id="currentPipeline" style="font-size: 0.9rem; font-weight: 600; color: #fff;">$0</div>
                        <div style="font-size: 0.65rem; margin-top: 0.3rem;" id="pipelineGapMsg">
                            <span style="color: var(--red);">Gap: $2M needed</span>
                        </div>
                    </div>
                </div>
                <div class="panel">
                    <div class="panel-title">üìà Win/Loss Record</div>
                    <div id="winLossStats" style="font-size: 0.7rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.3rem;">
                            <span style="color: var(--gray);">Submitted:</span>
                            <span id="outcomeSubmitted">0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.3rem;">
                            <span style="color: var(--green);">Won:</span>
                            <span id="outcomeWon" style="color: var(--green);">0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.3rem;">
                            <span style="color: var(--red);">Lost:</span>
                            <span id="outcomeLost" style="color: var(--red);">0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding-top: 0.3rem; border-top: 1px solid var(--border);">
                            <span style="color: var(--gray);">Actual Win Rate:</span>
                            <span id="actualWinRate" style="color: var(--green); font-weight: 600;">--</span>
                        </div>
                    </div>
                    <button class="btn btn-sm btn-secondary" style="width: 100%; margin-top: 0.5rem;" onclick="openOutcomeModal()">
                        üìù Record Outcome
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- OUTCOME RECORDING MODAL -->
    <div id="outcomeModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 3000; align-items: center; justify-content: center;">
        <div style="background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; max-width: 400px; width: 90%;">
            <h3 style="margin: 0 0 1rem; color: var(--green);">üìù Record Bid Outcome</h3>
            <div style="margin-bottom: 1rem;">
                <label style="font-size: 0.75rem; color: var(--gray);">Opportunity</label>
                <select id="outcomeOppSelect" style="width: 100%; padding: 0.5rem; background: #1a1a1a; border: 1px solid var(--border); border-radius: 4px; color: #fff; font-size: 0.85rem;">
                    <option value="">-- Select GO opportunity --</option>
                </select>
            </div>
            <div style="margin-bottom: 1rem;">
                <label style="font-size: 0.75rem; color: var(--gray);">Outcome</label>
                <select id="outcomeResult" style="width: 100%; padding: 0.5rem; background: #1a1a1a; border: 1px solid var(--border); border-radius: 4px; color: #fff; font-size: 0.85rem;">
                    <option value="">-- Select outcome --</option>
                    <option value="submitted">üì§ Submitted (awaiting result)</option>
                    <option value="won">üèÜ Won</option>
                    <option value="lost">‚ùå Lost</option>
                    <option value="no-bid">‚è≠Ô∏è No-Bid (decided not to pursue)</option>
                </select>
            </div>
            <div style="margin-bottom: 1rem;">
                <label style="font-size: 0.75rem; color: var(--gray);">Contract Value (if won)</label>
                <input type="text" id="outcomeValue" placeholder="e.g., $250,000" style="width: 100%; padding: 0.5rem; background: #1a1a1a; border: 1px solid var(--border); border-radius: 4px; color: #fff; font-size: 0.85rem;">
            </div>
            <div style="margin-bottom: 1rem;">
                <label style="font-size: 0.75rem; color: var(--gray);">Lessons Learned (optional)</label>
                <textarea id="outcomeLessons" rows="3" placeholder="What worked? What could improve?" style="width: 100%; padding: 0.5rem; background: #1a1a1a; border: 1px solid var(--border); border-radius: 4px; color: #fff; font-size: 0.85rem; resize: vertical;"></textarea>
            </div>
            <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeOutcomeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveOutcome()">üíæ Save Outcome</button>
            </div>
        </div>
    </div>
    <div class="page" id="page-purchasing">
        <div class="stats-bar" style="grid-template-columns: repeat(5, 1fr);">
            <div class="stat"><div class="stat-value" id="purchTotal">0</div><div class="stat-label">Total Eligible</div></div>
            <div class="stat"><div class="stat-value" id="purchPLC">0</div><div class="stat-label">PLC/Controls</div></div>
            <div class="stat"><div class="stat-value" id="purchRobotics">0</div><div class="stat-label">Robotics</div></div>
            <div class="stat"><div class="stat-value" id="purchVision">0</div><div class="stat-label">Vision/Sensors</div></div>
            <div class="stat"><div class="stat-value" id="purchMotion">0</div><div class="stat-label">Motion/VFD</div></div>
        </div>
        
        <div class="main main-full" style="max-width: 1200px;">
            <div class="panel">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <div>
                        <div class="panel-title" style="margin-bottom: 0;">üõí Purchasing Eligibility</div>
                        <p style="font-size: 0.75rem; color: var(--gray); margin-top: 0.25rem;">Opportunities with purchasable automation hardware or standard equipment</p>
                    </div>
                    <button class="btn btn-primary btn-sm" onclick="loadPurchasing()">üîÑ Analyze</button>
                </div>
                
                <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap;">
                    <button class="filter-pill active" data-purchfilter="all" onclick="filterPurchasing('all', this)">All Eligible</button>
                    <button class="filter-pill" data-purchfilter="PLC/Controls" onclick="filterPurchasing('PLC/Controls', this)">PLC/Controls</button>
                    <button class="filter-pill" data-purchfilter="Robotics" onclick="filterPurchasing('Robotics', this)">Robotics</button>
                    <button class="filter-pill" data-purchfilter="Vision/Sensors" onclick="filterPurchasing('Vision/Sensors', this)">Vision/Sensors</button>
                    <button class="filter-pill" data-purchfilter="Motion/VFD" onclick="filterPurchasing('Motion/VFD', this)">Motion/VFD</button>
                    <button class="filter-pill" data-purchfilter="Mixed" onclick="filterPurchasing('Mixed', this)">Mixed</button>
                </div>
                
                <div id="purchasingList" class="opp-list" style="max-height: calc(100vh - 350px);">
                    <div style="text-align: center; padding: 2rem; color: var(--gray);">
                        <div style="font-size: 2rem; opacity: 0.4;">üõí</div>
                        <h3 style="margin: 0.5rem 0;">Ready to Analyze</h3>
                        <p style="font-size: 0.8rem;">Click Analyze to scan opportunities for purchasable equipment</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SUBCONTRACTING PAGE -->
    <div class="page" id="page-subcontracting">
        <div class="main main-full" style="max-width: 1200px;">
            <div class="panel">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <div class="panel-title" style="margin-bottom: 0;">üéØ Subcontracting Opportunities</div>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <span id="subSource" style="font-size: 0.7rem; color: var(--orange);">üìä Demo</span>
                        <button class="btn btn-primary btn-sm" onclick="loadSubcontracting()">üîÑ Refresh</button>
                    </div>
                </div>
                <p style="font-size: 0.75rem; color: var(--gray); margin-bottom: 1rem;">Prime contractors with recent awards who may need robotics/automation subcontractors</p>
                
                <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                    <button class="filter-pill active" data-subfilter="all" onclick="filterSubs('all', this)">All</button>
                    <button class="filter-pill" data-subfilter="hot" onclick="filterSubs('hot', this)">üî• Hot</button>
                    <button class="filter-pill" data-subfilter="warm" onclick="filterSubs('warm', this)">üå°Ô∏è Warm</button>
                </div>
                
                <div id="subList" class="opp-list" style="max-height: calc(100vh - 300px);">
                    <div style="text-align: center; padding: 2rem; color: var(--gray);">
                        <p>Click Refresh to load subcontracting opportunities</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- PIPELINE PAGE -->
    <div class="page" id="page-pipeline">
        <div class="main main-full">
            <div class="panel">
                <div class="panel-title">üìä Application Pipeline</div>
                <div id="pipelineContent">
                    <div style="text-align: center; padding: 2rem; color: var(--gray);">
                        <p>Review opportunities in Scanner to build your pipeline</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI AGENT PAGE -->
    <div class="page" id="page-agent">
        <div class="main main-full">
            <div class="panel" id="proposalPanel">
                <div class="panel-title">ü§ñ AI Proposal Generator</div>
                <div class="form-group">
                    <label>Claude API Key</label>
                    <input type="password" id="agentClaudeKey" placeholder="sk-ant-api03-...">
                    <p class="form-hint">Get from <a href="https://console.anthropic.com" target="_blank">console.anthropic.com</a></p>
                </div>
                <div class="form-group">
                    <label>Select Opportunity (GO recommendations)</label>
                    <select id="oppSelect"><option value="">-- Scan first --</option></select>
                </div>
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="generateProposal()">üöÄ Generate Proposal</button>
                    <button class="btn btn-secondary" onclick="downloadProposal()">üìÑ Download Word</button>
                    <button class="btn btn-secondary" onclick="downloadTXT()">üìù Download TXT</button>
                </div>
                <div id="proposalOutput" style="display: none; margin-top: 1rem;">
                    <div style="background: #fff; color: #000; padding: 1.5rem; border-radius: 6px; max-height: 400px; overflow-y: auto; font-family: 'Times New Roman', serif;" id="proposalPreview"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- DETAIL MODAL -->
    <div class="modal-overlay" id="detailModal">
        <div class="modal">
            <div class="modal-header">
                <h2 id="modalTitle">Opportunity Details</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-footer" id="modalFooter"></div>
        </div>
    </div>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div id="loadingText" style="color: var(--gray);">Loading...</div>
        <div id="loadingActions" style="display: flex; gap: 0.5rem; margin-top: 1rem;">
            <button class="btn btn-secondary btn-sm" onclick="cancelScan()">‚úï Cancel</button>
            <button class="btn btn-sm" style="background: var(--card); color: var(--gray); border: 1px solid var(--border);" onclick="runInBackground()">Run in Background</button>
        </div>
        <div id="loadingProgress" style="color: var(--gray); font-size: 0.7rem; margin-top: 0.5rem;"></div>
    </div>

<script>
// ========== STATE ==========
const SINGH = { 
    naics: ['333249','333922','541330','541512','541715','238210'], 
    excluded: ['8(a)','hubzone','wosb','edwosb','sdvosb','vosb'],
    badIndustries: ['food','janitorial','medical','pharmaceutical','apparel','custodial','landscaping']
};
let opportunities = [];
let pipeline = {};
let outcomes = {};
// Initialize from storage safely
try {
    pipeline = JSON.parse(localStorage.getItem('pipeline') || '{}');
    outcomes = JSON.parse(localStorage.getItem('bidOutcomes') || '{}');
} catch (e) {
    console.warn('Could not load saved state:', e);
    pipeline = {};
    outcomes = {};
}
let currentTab = 'all';
let currentFilter = 'all';
let currentProposal = '';
let scanController = null; // AbortController for cancellable scans
let scanningInBackground = false;

// Price lookup table for common automation equipment
const PRICE_CATALOG = {
    'plc': [
        { name: 'Allen-Bradley CompactLogix 5380', partNum: '5069-L306ER', price: 2850, category: 'PLC' },
        { name: 'Siemens S7-1500', partNum: '6ES7 515-2AM02-0AB0', price: 3200, category: 'PLC' },
        { name: 'Allen-Bradley Micro850', partNum: '2080-LC50-48QWB', price: 890, category: 'PLC' }
    ],
    'hmi': [
        { name: 'Allen-Bradley PanelView Plus 7', partNum: '2711P-T10C22D9P', price: 4500, category: 'HMI' },
        { name: 'Siemens KTP700 Basic', partNum: '6AV2 123-2GB03-0AX0', price: 1200, category: 'HMI' }
    ],
    'robot': [
        { name: 'FANUC LR Mate 200iD/7L', partNum: 'A05B-1142-B201', price: 32000, category: 'Robot' },
        { name: 'FANUC M-20iD/25', partNum: 'A05B-1149-B201', price: 45000, category: 'Robot' },
        { name: 'Universal Robots UR10e', partNum: 'UR10e', price: 35000, category: 'Cobot' },
        { name: 'Universal Robots UR5e', partNum: 'UR5e', price: 27000, category: 'Cobot' }
    ],
    'vision': [
        { name: 'Cognex In-Sight 2000', partNum: 'IS2000M-110-40-125', price: 3800, category: 'Vision' },
        { name: 'Keyence IV3-500CA', partNum: 'IV3-500CA', price: 2900, category: 'Vision' },
        { name: 'FANUC iRVision 2D', partNum: 'A05B-1405-J901', price: 8500, category: 'Vision' }
    ],
    'vfd': [
        { name: 'Allen-Bradley PowerFlex 525', partNum: '25B-D010N104', price: 650, category: 'VFD' },
        { name: 'Siemens SINAMICS G120C', partNum: '6SL3210-1KE21-7UF1', price: 720, category: 'VFD' }
    ],
    'servo': [
        { name: 'Allen-Bradley Kinetix 5500', partNum: '2198-H040-ERS', price: 2400, category: 'Servo' },
        { name: 'FANUC Œ±i-F Servo', partNum: 'A06B-6290-H102', price: 3100, category: 'Servo' }
    ]
};

// ========== INIT ==========
document.addEventListener('DOMContentLoaded', () => {
    loadSettings();
    setupKeySync();
    updatePipelineStats();
    updateWinLossStats();
    log('Platform ready', 'success');
});

function log(msg, type = 'info') {
    const p = document.getElementById('logPanel');
    if (!p) return;
    const e = document.createElement('div');
    e.className = 'log-entry ' + type;
    e.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
    p.appendChild(e);
    p.scrollTop = p.scrollHeight;
}

function showLoading(t, showActions = true) { 
    document.getElementById('loadingText').textContent = t; 
    document.getElementById('loadingOverlay').classList.add('active');
    document.getElementById('loadingActions').style.display = showActions ? 'flex' : 'none';
    document.getElementById('loadingProgress').textContent = '';
}
function hideLoading() { 
    document.getElementById('loadingOverlay').classList.remove('active'); 
    scanningInBackground = false;
}
function updateLoadingProgress(text) {
    document.getElementById('loadingProgress').textContent = text;
}
function cancelScan() {
    if (scanController) {
        scanController.abort();
        scanController = null;
    }
    hideLoading();
    log('Scan cancelled', 'info');
}
function runInBackground() {
    scanningInBackground = true;
    hideLoading();
    log('Scan running in background...', 'info');
    // Show subtle indicator in header
    document.getElementById('statusText').textContent = 'Scanning...';
    document.getElementById('statusDot').style.animation = 'pulse 1s infinite';
}

// ========== API ==========
async function scanAll() {
    const url = document.getElementById('apiUrl').value;
    
    // Cancel any existing scan
    if (scanController) {
        scanController.abort();
    }
    scanController = new AbortController();
    
    showLoading('Scanning opportunities...');
    log('Connecting to ' + url, 'info');
    
    // Set timeout (15 seconds, then fallback to demo)
    const timeoutId = setTimeout(() => {
        if (scanController) {
            scanController.abort();
            log('API timeout - loading demo data...', 'info');
        }
    }, 15000);
    
    try {
        updateLoadingProgress('Fetching data from API...');
        const r = await fetch(url, { signal: scanController.signal });
        
        updateLoadingProgress('Parsing response...');
        const d = await r.json();
        
        if (d.success && d.opportunities) {
            processOpportunities(d.opportunities, 'Live');
        } else {
            throw new Error(d.error || 'Invalid response');
        }
    } catch (e) {
        if (e.name === 'AbortError') {
            log('Loading demo data...', 'info');
            loadDemoData();
        } else {
            log('API Error: ' + e.message + ' - Loading demo data...', 'error');
            loadDemoData();
        }
        document.getElementById('statusDot').style.animation = '';
    } finally {
        clearTimeout(timeoutId);
        scanController = null;
        if (!scanningInBackground) hideLoading();
        scanningInBackground = false;
    }
}

function processOpportunities(rawOpps, source) {
    updateLoadingProgress(`Processing ${rawOpps.length} opportunities...`);
    
    opportunities = rawOpps.map(o => {
        const match = calcMatch(o);
        return {
            ...o,
            matchScore: match.score,
            matchBreakdown: match.breakdown,
            eligibility: checkElig(o),
            link: getSamLink(o)
        };
    });
    opportunities.sort((a, b) => b.matchScore - a.matchScore);
    
    // Track for recompete detection
    trackSeenOpportunities(rawOpps);
    
    document.getElementById('statusDot').className = 'status-dot live';
    document.getElementById('statusDot').style.animation = '';
    document.getElementById('statusText').textContent = source;
    log(`Loaded ${opportunities.length} opportunities (${source})`, 'success');
    
    renderTabs();
    renderOpps();
    updateStats();
    renderQualifiedList();
    updateOppSelect();
    updateRevenueCalculator();
}

function loadDemoData() {
    log('üìã Loading demo data (10 sample opportunities)...', 'info');
    const demoOpps = [
        {
            id: 'DEMO-001', noticeId: 'DEMO-001',
            title: 'Navy Shipyard Automation Program',
            description: 'Upcoming automation and robotics modernization for naval shipyards. Pre-RFP stage. Seeking robotic welding systems, PLC controls, and vision inspection equipment for hull manufacturing.',
            agency: 'NAVSEA', value: 2500000, type: 'forecast', category: 'Forecast',
            closeDate: new Date(Date.now() + 195 * 86400000).toISOString(),
            setAside: 'Full & Open', naicsCode: '333249',
            solicitation: 'NAVSEA-FY25-AUTO', isLive: false
        },
        {
            id: 'DEMO-002', noticeId: 'DEMO-002',
            title: 'Robotic Welding Cell - Michigan Defense Facility',
            description: 'Turnkey robotic welding cell for armored vehicle components. Requires FANUC robot integration, safety systems, and PLC-based automation controls.',
            agency: 'US Army TACOM', value: 1800000, type: 'contract', category: 'Contract',
            closeDate: new Date(Date.now() + 45 * 86400000).toISOString(),
            setAside: 'Small Business', naicsCode: '333249',
            solicitation: 'W56HZV-25-R-0042', isLive: true
        },
        {
            id: 'DEMO-003', noticeId: 'DEMO-003',
            title: 'Army Depot Welding Cells Integration',
            description: 'Integration services for automated welding systems at Army depot. Universal Robots cobot deployment, vision-guided welding, conveyor integration.',
            agency: 'Army Materiel Command', value: 3200000, type: 'contract', category: 'Contract',
            closeDate: new Date(Date.now() + 30 * 86400000).toISOString(),
            setAside: 'Full & Open', naicsCode: '541330',
            solicitation: 'W912DY-25-R-0018', isLive: true
        },
        {
            id: 'DEMO-004', noticeId: 'DEMO-004',
            title: 'SCADA Modernization - CA State Water',
            description: 'Modernization of SCADA and PLC control systems for state water treatment facilities. Allen-Bradley PLC migration, HMI upgrades, network security.',
            agency: 'CA Dept of Water Resources', value: 950000, type: 'state', category: 'State',
            closeDate: new Date(Date.now() + 21 * 86400000).toISOString(),
            setAside: 'Small Business', naicsCode: '541512',
            solicitation: 'DWR-2025-0089', isLive: true
        },
        {
            id: 'DEMO-005', noticeId: 'DEMO-005',
            title: 'Warehouse Automation System - GSA',
            description: 'Automated material handling and conveyor systems for federal warehouse. Includes robotic palletizing, barcode vision inspection, and warehouse management integration.',
            agency: 'GSA Federal Acquisition Service', value: 4100000, type: 'contract', category: 'Contract',
            closeDate: new Date(Date.now() + 60 * 86400000).toISOString(),
            setAside: 'Full & Open', naicsCode: '333922',
            solicitation: 'GS-07F-0234Y', isLive: true
        },
        {
            id: 'DEMO-006', noticeId: 'DEMO-006',
            title: 'Vision Inspection System for Ammunition',
            description: 'Automated vision inspection system for ammunition quality control. Cognex vision systems, high-speed cameras, defect detection AI integration.',
            agency: 'Army Contracting Command', value: 780000, type: 'contract', category: 'Contract',
            closeDate: new Date(Date.now() + 14 * 86400000).toISOString(),
            setAside: 'Small Business', naicsCode: '333249',
            solicitation: 'W52P1J-25-R-0067', isLive: true
        },
        {
            id: 'DEMO-007', noticeId: 'DEMO-007',
            title: 'Collaborative Robot Research Platform',
            description: 'SBIR Phase II: Development of collaborative robot workcell for flexible manufacturing research. UR10e integration, safety systems, ROS2 control.',
            agency: 'NSF', value: 500000, type: 'sbir', category: 'SBIR',
            closeDate: new Date(Date.now() + 90 * 86400000).toISOString(),
            setAside: 'SBIR', naicsCode: '541715',
            solicitation: 'NSF-SBIR-2025-II-023', isLive: true
        },
        {
            id: 'DEMO-008', noticeId: 'DEMO-008',
            title: 'Servo Motor Procurement - Navy',
            description: 'Procurement of servo motors and VFD drives for shipboard machinery. FANUC servo systems, Allen-Bradley PowerFlex drives, spares package.',
            agency: 'NAVSUP', value: 320000, type: 'dibbs', category: 'DIBBS',
            closeDate: new Date(Date.now() + 7 * 86400000).toISOString(),
            setAside: 'Full & Open', naicsCode: '333249',
            solicitation: 'N00104-25-Q-0891', isLive: true
        },
        {
            id: 'DEMO-009', noticeId: 'DEMO-009',
            title: 'Automated Assembly Line - VA Medical',
            description: 'Automated pharmacy assembly and dispensing system for VA hospital. Robotic pick-and-place, barcode verification, integration with hospital systems.',
            agency: 'Department of Veterans Affairs', value: 1500000, type: 'contract', category: 'Contract',
            closeDate: new Date(Date.now() + 35 * 86400000).toISOString(),
            setAside: 'SDVOSB', naicsCode: '541512',
            solicitation: '36C24625R0012', isLive: true
        },
        {
            id: 'DEMO-010', noticeId: 'DEMO-010',
            title: 'PLC Training Simulators',
            description: 'Procurement of PLC training simulator systems for technical training center. Siemens S7-1500, Allen-Bradley CompactLogix, HMI panels.',
            agency: 'Dept of Labor', value: 185000, type: 'contract', category: 'Contract',
            closeDate: new Date(Date.now() + 25 * 86400000).toISOString(),
            setAside: 'Small Business', naicsCode: '333249',
            solicitation: 'DOL-OPS-25-Q-0034', isLive: true
        }
    ];
    
    processOpportunities(demoOpps, 'Demo');
}

// Generate proper SAM.gov link from opportunity data
function getSamLink(o) {
    // If we have a proper uiLink from API, use it
    if (o.uiLink && o.uiLink.includes('sam.gov/opp/')) {
        return o.uiLink;
    }
    // If link exists and is a proper opportunity link, use it
    if (o.link && o.link.includes('sam.gov/opp/')) {
        return o.link;
    }
    // Construct from noticeId
    if (o.noticeId) {
        return `https://sam.gov/opp/${o.noticeId}/view`;
    }
    // Construct from id if it looks like a SAM notice ID
    if (o.id && o.id.length > 20) {
        return `https://sam.gov/opp/${o.id}/view`;
    }
    // Fallback to generic SAM.gov search
    const searchTerm = encodeURIComponent(o.solicitation || o.title || '');
    return `https://sam.gov/search/?keywords=${searchTerm}&index=opp`;
}

function checkElig(o) {
    // If API already provided qualification status, use it
    if (o.qualification && o.qualification.status) {
        const status = o.qualification.status;
        return {
            ok: status === 'GO' || status === 'Review',
            reason: o.qualification.reason || o.statusReason || 'See details',
            status: status,
            recommendation: o.qualification.recommendation || status,
            breakdown: o.qualification.breakdown || o.matchBreakdown
        };
    }
    
    // Fallback to local checking
    const sa = (o.setAside || '').toLowerCase();
    const txt = ((o.title || '') + ' ' + (o.description || '')).toLowerCase();
    
    // Hard NO-GO rules
    if (sa.includes('sdvosb') || sa.includes('service-disabled veteran')) {
        return { ok: false, reason: 'Restricted to SDVOSB primes; Singh is not SDVOSB.', status: 'NO-GO', recommendation: 'No-Go' };
    }
    if (sa.includes('8(a)') || sa.includes('8a')) {
        return { ok: false, reason: 'Restricted to 8(a) firms; Singh is not 8(a) certified.', status: 'NO-GO', recommendation: 'No-Go' };
    }
    if (sa.includes('hubzone')) {
        return { ok: false, reason: 'Restricted to HUBZone firms; Singh is not HUBZone certified.', status: 'NO-GO', recommendation: 'No-Go' };
    }
    
    // Vehicle restrictions
    const vehicles = ['seaport nxg', 'seaport-e', 'oasis', 'gsa mas', 'gsa schedule', 'sewp', 'cio-sp3', 'stars iii', 'alliant'];
    for (const v of vehicles) {
        if (txt.includes(v) && (txt.includes('holders only') || txt.includes('contract holders') || txt.includes('task order under'))) {
            return { ok: false, reason: `Restricted to ${v.toUpperCase()} holders; Singh is not a holder.`, status: 'NO-GO', recommendation: 'No-Go' };
        }
    }
    
    for (const c of SINGH.excluded) {
        if (sa.includes(c)) return { ok: false, reason: `Requires ${c.toUpperCase()}`, status: 'NO-GO', recommendation: 'No-Go' };
    }
    for (const i of SINGH.badIndustries) {
        if (txt.includes(i) && !txt.includes('robot') && !txt.includes('automation')) {
            return { ok: false, reason: `Industry: ${i}`, status: 'Review', recommendation: 'Review' };
        }
    }
    const n = o.naicsCode || '';
    if (n && n.length >= 6 && !SINGH.naics.some(x => n.startsWith(x.substring(0, 4)))) {
        return { ok: false, reason: `NAICS ${n} not registered`, status: 'Review', recommendation: 'Review' };
    }
    return { ok: true, reason: 'Eligible to bid', status: 'GO', recommendation: 'GO' };
}

function calcMatch(o) {
    let s = 30; // Lower base to make room for more signals
    const breakdown = [{ label: 'Base', points: 30 }];
    const t = ((o.title || '') + ' ' + (o.description || '')).toLowerCase();
    
    // === KEYWORD SIGNALS ===
    if (t.includes('robot')) { s += 15; breakdown.push({ label: 'Robot keyword', points: 15 }); }
    if (t.includes('vision') || t.includes('inspection')) { s += 12; breakdown.push({ label: 'Vision/Inspection', points: 12 }); }
    if (t.includes('automation')) { s += 10; breakdown.push({ label: 'Automation keyword', points: 10 }); }
    if (t.includes('plc') || t.includes('scada')) { s += 10; breakdown.push({ label: 'PLC/SCADA', points: 10 }); }
    if (t.includes('welding')) { s += 10; breakdown.push({ label: 'Welding', points: 10 }); }
    if (t.includes('conveyor') || t.includes('material handling')) { s += 8; breakdown.push({ label: 'Conveyor/MH', points: 8 }); }
    if (t.includes('fanuc')) { s += 15; breakdown.push({ label: 'FANUC match', points: 15 }); }
    if (t.includes('universal robot') || t.includes('ur10') || t.includes('ur5') || t.includes('cobot')) { s += 12; breakdown.push({ label: 'UR/Cobot', points: 12 }); }
    if (t.includes('integrat')) { s += 8; breakdown.push({ label: 'Integration scope', points: 8 }); }
    
    // === NAICS ALIGNMENT ===
    if (o.naicsCode && SINGH.naics.includes(o.naicsCode)) { 
        s += 12; breakdown.push({ label: 'NAICS match', points: 12 }); 
    }
    
    // === CONTRACT VALUE SIGNALS ===
    const value = parseFloat(o.value) || 0;
    if (value >= 5000000) { s += 10; breakdown.push({ label: 'Value ‚â•$5M', points: 10 }); }
    else if (value >= 1000000) { s += 8; breakdown.push({ label: 'Value ‚â•$1M', points: 8 }); }
    else if (value >= 250000) { s += 5; breakdown.push({ label: 'Value ‚â•$250K', points: 5 }); }
    else if (value > 0 && value < 50000) { s -= 5; breakdown.push({ label: 'Low value (<$50K)', points: -5 }); }
    
    // === TIME-TO-BID SIGNALS ===
    const days = daysUntil(o.closeDate);
    if (days <= 5 && days > 0) { s -= 10; breakdown.push({ label: 'Very short deadline (‚â§5d)', points: -10 }); }
    else if (days <= 10 && days > 0) { s -= 5; breakdown.push({ label: 'Short deadline (‚â§10d)', points: -5 }); }
    else if (days >= 30 && days <= 60) { s += 5; breakdown.push({ label: 'Good lead time (30-60d)', points: 5 }); }
    
    // === SET-ASIDE ALIGNMENT ===
    const setAside = (o.setAside || '').toLowerCase();
    if (setAside.includes('small business') && !setAside.includes('8(a)') && !setAside.includes('hubzone') && !setAside.includes('sdvosb')) {
        s += 8; breakdown.push({ label: 'SB set-aside (eligible)', points: 8 });
    }
    if (setAside.includes('full and open') || setAside === '') {
        s += 3; breakdown.push({ label: 'Full & Open', points: 3 });
    }
    
    // === RECOMPETE DETECTION ===
    try {
        const seenOpps = JSON.parse(localStorage.getItem('seenOpportunities') || '{}');
        if (seenOpps[o.id || o.noticeId]) {
            const firstSeen = new Date(seenOpps[o.id || o.noticeId]);
            const daysSeen = Math.floor((new Date() - firstSeen) / 86400000);
            if (daysSeen > 7) {
                breakdown.push({ label: 'üîÑ Recompete detected', points: 0, info: true });
            }
        }
    } catch (e) { /* localStorage unavailable */ }
    
    return { score: Math.max(0, Math.min(s, 99)), breakdown };
}

// Track seen opportunities for recompete detection
function trackSeenOpportunities(opps) {
    try {
        const seen = JSON.parse(localStorage.getItem('seenOpportunities') || '{}');
        const now = new Date().toISOString();
        opps.forEach(o => {
            const id = o.id || o.noticeId;
            if (id && !seen[id]) {
                seen[id] = now;
            }
        });
        // Prune old entries (> 90 days)
        const cutoff = Date.now() - (90 * 24 * 60 * 60 * 1000);
        Object.keys(seen).forEach(k => {
            if (new Date(seen[k]).getTime() < cutoff) delete seen[k];
        });
        safeStorage('seenOpportunities', seen);
    } catch (e) {
        console.warn('Could not track opportunities:', e);
    }
}

function fmtCurrency(v) {
    if (!v) return 'TBD';
    const n = parseFloat(v);
    if (isNaN(n)) return 'TBD';
    return n >= 1e6 ? '$' + (n/1e6).toFixed(1) + 'M' : n >= 1e3 ? '$' + (n/1e3).toFixed(0) + 'K' : '$' + n.toLocaleString();
}

function fmtDate(d) { if (!d) return 'N/A'; try { return new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }); } catch { return 'N/A'; } }
function daysUntil(d) { if (!d) return 999; try { return Math.ceil((new Date(d) - new Date()) / 86400000); } catch { return 999; } }

// ========== RENDERING ==========
function renderTabs() {
    const c = { all: opportunities.length, contract: 0, sbir: 0, state: 0, dibbs: 0, forecast: 0, qualified: 0 };
    opportunities.forEach(o => {
        if (o.type === 'contract') c.contract++;
        if (o.type === 'sbir') c.sbir++;
        if (o.type === 'state') c.state++;
        if (o.type === 'dibbs') c.dibbs++;
        if (o.type === 'forecast') c.forecast++;
        if (o.eligibility.ok) c.qualified++;
    });
    document.getElementById('tabsContainer').innerHTML = `
        <button class="tab ${currentTab==='all'?'active':''}" data-tab="all">All ${c.all}</button>
        <button class="tab ${currentTab==='contract'?'active':''}" data-tab="contract">Federal ${c.contract}</button>
        <button class="tab ${currentTab==='sbir'?'active':''}" data-tab="sbir">SBIR ${c.sbir}</button>
        <button class="tab ${currentTab==='state'?'active':''}" data-tab="state">State ${c.state}</button>
        <button class="tab ${currentTab==='dibbs'?'active':''}" data-tab="dibbs">DIBBS ${c.dibbs}</button>
        <button class="tab ${currentTab==='qualified'?'active':''}" data-tab="qualified">‚úÖ Qualified ${c.qualified}</button>
    `;
}

function renderOpps() {
    const c = document.getElementById('oppList');
    const s = (document.getElementById('searchInput').value || '').toLowerCase();
    
    let f = opportunities.filter(o => {
        // Tab filtering
        if (currentTab === 'qualified' && !o.eligibility.ok) return false;
        if (currentTab === 'contract' && o.type !== 'contract') return false;
        if (currentTab === 'sbir' && o.type !== 'sbir') return false;
        if (currentTab === 'state' && o.type !== 'state') return false;
        if (currentTab === 'dibbs' && o.type !== 'dibbs') return false;
        if (currentTab === 'forecast' && o.type !== 'forecast') return false;
        
        // Category filter (from filter pills)
        if (currentFilter !== 'all') {
            if (currentFilter === 'contract' && o.type !== 'contract') return false;
            if (currentFilter === 'sbir' && o.type !== 'sbir') return false;
            if (currentFilter === 'state' && o.type !== 'state') return false;
            if (currentFilter === 'dibbs' && o.type !== 'dibbs') return false;
            if (currentFilter === 'forecast' && o.type !== 'forecast') return false;
        }
        
        // Search filter
        if (s && !((o.title||'')+' '+(o.description||'')+' '+(o.agency||'')).toLowerCase().includes(s)) return false;
        return true;
    });
    
    if (!f.length) {
        c.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--gray);"><h3>No matches</h3></div>';
        return;
    }
    
    c.innerHTML = f.map(o => {
        const d = daysUntil(o.closeDate);
        const sc = o.matchScore >= 70 ? '' : o.matchScore >= 50 ? 'medium' : 'low';
        const status = pipeline[o.id]?.status || null;
        const typeBadge = getTypeBadgeColor(o.type);
        const qualStatus = o.qualification?.status || o.status || (o.eligibility.ok ? 'GO' : 'NO-GO');
        const recommendation = o.qualification?.recommendation || o.recommendation || qualStatus;
        
        // Determine card border based on qualification
        let cardClass = 'opp-card';
        if (qualStatus === 'GO') cardClass += ' qualified';
        else if (qualStatus === 'NO-GO') cardClass += ' not-qualified';
        else cardClass += ' review';
        
        return `<div class="${cardClass}" data-id="${o.id}">
            <div class="opp-header">
                <div class="opp-title">${o.title}</div>
                <span class="opp-type" style="background: ${typeBadge.bg}; color: ${typeBadge.color}">${(o.category || o.type || 'contract').toUpperCase()}</span>
            </div>
            <div class="opp-meta">
                <span>üèõÔ∏è ${(o.agency||'Agency').substring(0,40)}</span>
                <span>üí∞ ${fmtCurrency(o.value)}</span>
                <span>üìÖ ${fmtDate(o.closeDate)} ${d > 0 && d < 14 ? '‚ö†Ô∏è' : ''}</span>
                ${o.source ? `<span style="color: var(--gray); font-size: 0.7rem;">via ${o.source}</span>` : ''}
            </div>
            <div class="opp-desc">${(o.description||'').substring(0,120)}...</div>
            <div class="opp-tags">
                ${o.isLive ? '<span class="tag">üü¢ LIVE</span>' : ''}
                ${qualStatus === 'GO' ? '<span class="tag" style="background: rgba(154,205,50,0.2);">‚úÖ GO</span>' : ''}
                ${qualStatus === 'Review' ? '<span class="tag" style="background: rgba(245,158,11,0.2); color: var(--orange);">üîç REVIEW</span>' : ''}
                ${qualStatus === 'NO-GO' ? '<span class="tag tag-nq">üö´ NO-GO</span>' : ''}
                ${status === 'go' ? '<span class="tag" style="background: rgba(154,205,50,0.3);">üìå MARKED GO</span>' : ''}
            </div>
            <div class="match-score ${sc} score-badge">
                ${o.matchScore}%
                <div class="score-tooltip">
                    <div class="score-tooltip-title">üìä Score Breakdown</div>
                    ${(o.matchBreakdown || []).map(b => b.info 
                        ? `<div class="score-tooltip-row" style="color: var(--blue);"><span>${b.label}</span><span>‚ÑπÔ∏è</span></div>`
                        : `<div class="score-tooltip-row">
                            <span>${b.label}</span>
                            <span style="color: ${b.points >= 0 ? 'var(--green)' : 'var(--red)'};">${b.points >= 0 ? '+' : ''}${b.points}</span>
                          </div>`
                    ).join('')}
                    <div class="score-tooltip-row" style="border-top: 1px solid var(--border); margin-top: 0.3rem; padding-top: 0.3rem;">
                        <span>Total</span>
                        <span>${o.matchScore}%</span>
                    </div>
                </div>
            </div>
        </div>`;
    }).join('');
}

function renderQualifiedList() {
    const list = document.getElementById('qualifiedList');
    const qual = opportunities.filter(o => o.eligibility.ok).slice(0, 5);
    
    if (!qual.length) {
        list.innerHTML = '<div style="font-size: 0.75rem; color: var(--gray);">No qualified opportunities</div>';
        return;
    }
    
    list.innerHTML = qual.map(o => {
        const status = pipeline[o.id]?.status;
        return `<div class="alert-item" onclick="showDetail('${o.id}')">
            <span class="alert-dot ${status === 'go' ? 'green' : status === 'review' ? 'orange' : 'green'}"></span>
            <span style="flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${o.title.substring(0,30)}...</span>
            <span style="color: var(--green); font-weight: 600;">${o.matchScore}%</span>
        </div>`;
    }).join('');
}

function updateStats() {
    const q = opportunities.filter(o => o.eligibility.ok);
    const u = opportunities.filter(o => { const d = daysUntil(o.closeDate); return d <= 14 && d > 0; });
    const tv = opportunities.reduce((s, o) => s + (parseFloat(o.value) || 0), 0);
    const am = opportunities.length ? Math.round(opportunities.reduce((s, o) => s + o.matchScore, 0) / opportunities.length) : 0;
    
    document.getElementById('statLive').textContent = opportunities.filter(o => o.isLive).length;
    document.getElementById('statTotal').textContent = opportunities.length;
    document.getElementById('statQualified').textContent = q.length;
    document.getElementById('statUrgent').textContent = u.length;
    document.getElementById('statValue').textContent = fmtCurrency(tv);
    document.getElementById('statMatch').textContent = am + '%';
}

function updateOppSelect() {
    const sel = document.getElementById('oppSelect');
    const qual = opportunities.filter(o => o.eligibility.ok && (!pipeline[o.id] || pipeline[o.id].status === 'go'));
    sel.innerHTML = `<option value="">-- ${qual.length} qualified opportunities --</option>` +
        qual.map(o => `<option value="${o.id}">${o.title.substring(0,50)}... | ${fmtCurrency(o.value)}</option>`).join('');
}

function updatePipelineStats() {
    const goCount = Object.values(pipeline).filter(p => p.status === 'go').length;
    const reviewCount = Object.values(pipeline).filter(p => p.status === 'review').length;
    const nogoCount = Object.values(pipeline).filter(p => p.status === 'nogo').length;
    
    document.getElementById('pipelineGo').textContent = goCount;
    document.getElementById('pipelineReview').textContent = reviewCount;
    document.getElementById('pipelineNoGo').textContent = nogoCount;
    
    // Update revenue calculator when pipeline changes
    updateRevenueCalculator();
}

function updateRevenueCalculator() {
    const goalInput = document.getElementById('revenueGoal');
    const winRateInput = document.getElementById('winRate');
    if (!goalInput || !winRateInput) return;
    
    // Parse goal (handle formats like "500000", "500K", "1M", "$500,000")
    let goalStr = goalInput.value.replace(/[$,]/g, '').toUpperCase();
    let goal = parseFloat(goalStr);
    if (goalStr.includes('K')) goal = parseFloat(goalStr) * 1000;
    if (goalStr.includes('M')) goal = parseFloat(goalStr) * 1000000;
    if (isNaN(goal)) goal = 500000;
    
    const winRate = Math.max(1, Math.min(100, parseInt(winRateInput.value) || 25)) / 100;
    
    // Calculate pipeline needed (goal / win rate)
    const pipelineNeeded = goal / winRate;
    
    // Calculate current GO pipeline value
    let currentValue = 0;
    Object.entries(pipeline).forEach(([id, p]) => {
        if (p.status === 'go') {
            const opp = opportunities.find(o => o.id === id);
            if (opp && opp.value) {
                currentValue += parseFloat(opp.value) || 0;
            }
        }
    });
    
    // Calculate gap
    const gap = pipelineNeeded - currentValue;
    const percentComplete = pipelineNeeded > 0 ? Math.min(100, (currentValue / pipelineNeeded) * 100) : 0;
    
    // Update display
    document.getElementById('pipelineNeeded').textContent = fmtCurrency(pipelineNeeded);
    document.getElementById('currentPipeline').textContent = fmtCurrency(currentValue);
    
    const gapMsg = document.getElementById('pipelineGapMsg');
    if (gap <= 0) {
        gapMsg.innerHTML = `<span style="color: var(--green);">‚úÖ Target met! ${Math.round(percentComplete)}% of goal</span>`;
    } else {
        gapMsg.innerHTML = `<span style="color: var(--orange);">Gap: ${fmtCurrency(gap)} needed</span>
            <div style="background: #333; height: 4px; border-radius: 2px; margin-top: 0.3rem; overflow: hidden;">
                <div style="background: var(--green); height: 100%; width: ${percentComplete}%; transition: width 0.3s;"></div>
            </div>
            <div style="font-size: 0.6rem; color: var(--gray); margin-top: 0.2rem;">${Math.round(percentComplete)}% of pipeline target</div>`;
    }
}

// ========== WIN/LOSS OUTCOME TRACKING ==========
function openOutcomeModal() {
    const modal = document.getElementById('outcomeModal');
    const select = document.getElementById('outcomeOppSelect');
    
    // Populate with GO opportunities
    const goOpps = Object.entries(pipeline)
        .filter(([id, p]) => p.status === 'go')
        .map(([id, p]) => {
            const opp = opportunities.find(o => o.id === id);
            return opp ? { id, title: opp.title, value: opp.value } : null;
        })
        .filter(Boolean);
    
    select.innerHTML = '<option value="">-- Select GO opportunity --</option>' +
        goOpps.map(o => `<option value="${o.id}">${o.title.substring(0,40)}... | ${fmtCurrency(o.value)}</option>`).join('');
    
    // Clear previous values
    document.getElementById('outcomeResult').value = '';
    document.getElementById('outcomeValue').value = '';
    document.getElementById('outcomeLessons').value = '';
    
    modal.style.display = 'flex';
}

function closeOutcomeModal() {
    document.getElementById('outcomeModal').style.display = 'none';
}

function saveOutcome() {
    const oppId = document.getElementById('outcomeOppSelect').value;
    const result = document.getElementById('outcomeResult').value;
    const value = document.getElementById('outcomeValue').value;
    const lessons = document.getElementById('outcomeLessons').value;
    
    if (!oppId || !result) {
        alert('Please select an opportunity and outcome.');
        return;
    }
    
    const opp = opportunities.find(o => o.id === oppId);
    
    outcomes[oppId] = {
        result,
        value: value || null,
        lessons: lessons || null,
        recordedAt: new Date().toISOString(),
        matchScore: opp?.matchScore || 0,
        title: opp?.title || 'Unknown',
        agency: opp?.agency || 'Unknown'
    };
    
    safeStorage('bidOutcomes', outcomes);
    updateWinLossStats();
    closeOutcomeModal();
    log(`Outcome recorded: ${result} for ${opp?.title?.substring(0, 30)}...`, 'success');
}

function updateWinLossStats() {
    const allOutcomes = Object.values(outcomes);
    const submitted = allOutcomes.filter(o => o.result === 'submitted').length;
    const won = allOutcomes.filter(o => o.result === 'won').length;
    const lost = allOutcomes.filter(o => o.result === 'lost').length;
    const decided = won + lost; // Only count decided outcomes for win rate
    
    document.getElementById('outcomeSubmitted').textContent = submitted;
    document.getElementById('outcomeWon').textContent = won;
    document.getElementById('outcomeLost').textContent = lost;
    
    const actualWinRate = decided > 0 ? Math.round((won / decided) * 100) : '--';
    document.getElementById('actualWinRate').textContent = decided > 0 ? actualWinRate + '%' : '--';
    
    // If we have real data, suggest updating the win rate input
    if (decided >= 3) {
        const winRateInput = document.getElementById('winRate');
        const currentRate = parseInt(winRateInput.value) || 25;
        if (Math.abs(currentRate - actualWinRate) > 10) {
            // Show hint that actual rate differs significantly
            document.getElementById('actualWinRate').innerHTML = `${actualWinRate}% <span style="font-size: 0.6rem; color: var(--orange);" title="Your actual win rate differs from your target. Consider updating.">‚ö†Ô∏è</span>`;
        }
    }
    
    // Calculate won revenue
    const wonRevenue = allOutcomes
        .filter(o => o.result === 'won' && o.value)
        .reduce((sum, o) => {
            let v = String(o.value).replace(/[$,]/g, '').toUpperCase();
            let n = parseFloat(v);
            if (v.includes('K')) n = parseFloat(v) * 1000;
            if (v.includes('M')) n = parseFloat(v) * 1000000;
            return sum + (isNaN(n) ? 0 : n);
        }, 0);
    
    if (wonRevenue > 0) {
        document.getElementById('outcomeWon').innerHTML = `${won} <span style="font-size: 0.6rem; color: var(--green);">(${fmtCurrency(wonRevenue)})</span>`;
    }
}

// ========== MODAL & VALIDATION ==========
function showDetail(id) {
    const o = opportunities.find(x => x.id === id);
    if (!o) return;
    
    const status = pipeline[o.id]?.status;
    const validation = pipeline[o.id]?.validation;
    
    // Get qualification info from API or fallback
    const qual = o.qualification || {};
    const qualStatus = qual.status || o.status || (o.eligibility.ok ? 'GO' : 'NO-GO');
    const qualReason = qual.reason || o.statusReason || o.eligibility.reason;
    const recommendation = qual.recommendation || qualStatus;
    const breakdown = qual.breakdown || o.matchBreakdown || {};
    
    document.getElementById('modalTitle').textContent = o.title;
    
    // Analyze Purchasing Eligibility
    const purchasingElig = analyzePurchasingEligibility(o);
    
    // Determine banner style
    let bannerClass = 'go';
    let bannerIcon = '‚úÖ';
    let bannerTitle = 'GO - PURSUE';
    
    if (qualStatus === 'NO-GO' || status === 'nogo') {
        bannerClass = 'nogo';
        bannerIcon = 'üö´';
        bannerTitle = 'NO-GO';
    } else if (qualStatus === 'Review' || status === 'review') {
        bannerClass = 'review';
        bannerIcon = 'üîç';
        bannerTitle = 'NEEDS REVIEW';
    } else if (status === 'go') {
        bannerClass = 'go';
        bannerIcon = '‚úÖ';
        bannerTitle = 'GO - PURSUE';
    }
    
    let body = `
        <!-- PURCHASING ELIGIBILITY SECTION -->
        <div style="background: ${purchasingElig.eligible ? 'rgba(59,130,246,0.1)' : 'rgba(100,100,100,0.1)'}; border: 1px solid ${purchasingElig.eligible ? 'var(--blue)' : '#555'}; border-radius: 8px; padding: 0.75rem; margin-bottom: 1rem;">
            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                <span style="font-size: 1rem;">${purchasingElig.eligible ? 'üõí' : 'üìã'}</span>
                <strong style="color: ${purchasingElig.eligible ? 'var(--blue)' : '#888'}; font-size: 0.9rem;">Purchasing Eligibility</strong>
            </div>
            <div style="font-size: 0.8rem; display: flex; flex-direction: column; gap: 0.3rem;">
                <div><strong>Eligible:</strong> <span style="color: ${purchasingElig.eligible ? 'var(--green)' : 'var(--gray)'}; font-weight: 600;">${purchasingElig.eligible ? 'YES' : 'NO'}</span></div>
                <div><strong>Category:</strong> <span style="color: var(--blue);">${purchasingElig.category}</span></div>
                <div><strong>Reason:</strong> <span style="color: var(--gray);">${purchasingElig.reason}</span></div>
            </div>
        </div>
        
        <div class="eligibility-banner ${bannerClass}">
            <div class="icon">${bannerIcon}</div>
            <div class="text">
                <strong>${bannerTitle}</strong>
                <p>${qualReason}</p>
            </div>
        </div>
        
        <div class="modal-grid">
            <div class="modal-item"><label>Type</label><strong>${(o.type||'contract').toUpperCase()}</strong></div>
            <div class="modal-item"><label>Source</label><strong>${o.source||'SAM.gov'}</strong></div>
            <div class="modal-item"><label>Solicitation</label><strong>${o.solicitation||'N/A'}</strong></div>
            <div class="modal-item"><label>Value</label><strong>${fmtCurrency(o.value)}</strong></div>
            <div class="modal-item"><label>Closes</label><strong>${fmtDate(o.closeDate)} (${daysUntil(o.closeDate)}d)</strong></div>
            <div class="modal-item"><label>Set-Aside</label><strong>${o.setAside||'Full & Open'}</strong></div>
            <div class="modal-item"><label>Agency</label><strong>${(o.agency||'Federal').substring(0,50)}</strong></div>
            <div class="modal-item"><label>NAICS</label><strong>${o.naicsCode||'N/A'}</strong></div>
        </div>
        
        <!-- Match Breakdown Section -->
        ${Object.keys(breakdown).length > 0 ? `
        <div style="background: rgba(154,205,50,0.1); padding: 0.75rem; border-radius: 6px; margin-bottom: 1rem; border: 1px solid rgba(154,205,50,0.3);">
            <strong style="font-size: 0.75rem; color: var(--green);">üìä Match Breakdown</strong>
            <div style="margin-top: 0.5rem; font-size: 0.8rem;">
                ${breakdown.naics ? `<div style="margin-bottom: 0.3rem;"><strong>NAICS:</strong> ${breakdown.naics}</div>` : ''}
                ${breakdown.setAside ? `<div style="margin-bottom: 0.3rem;"><strong>Set-Aside:</strong> ${breakdown.setAside}</div>` : ''}
                ${breakdown.keywords ? `<div style="margin-bottom: 0.3rem;"><strong>Keywords:</strong> ${breakdown.keywords}</div>` : ''}
                ${breakdown.restrictions ? `<div style="margin-bottom: 0.3rem;"><strong>Restrictions:</strong> ${breakdown.restrictions}</div>` : ''}
                ${breakdown.program ? `<div style="margin-bottom: 0.3rem;"><strong>Program:</strong> ${breakdown.program}</div>` : ''}
                ${breakdown.eligibility ? `<div style="margin-bottom: 0.3rem;"><strong>Eligibility:</strong> ${breakdown.eligibility}</div>` : ''}
            </div>
        </div>
        ` : ''}
        
        <div style="background: #1a1a1a; padding: 0.75rem; border-radius: 6px; margin-bottom: 1rem;">
            <strong style="font-size: 0.75rem; color: var(--gray);">Description</strong>
            <p style="font-size: 0.8rem; margin-top: 0.4rem; line-height: 1.5;">${o.description||'No description'}</p>
        </div>
    `;
    
    // Show validation results if available
    if (validation) {
        body += `
            <div class="validation-section">
                <h3>üìã Validation Checks</h3>
                <div class="check-list">
                    ${validation.checks.map(c => `
                        <div class="check-item">
                            <div class="check-status ${c.status.toLowerCase()}">${c.status === 'PASS' ? '‚úì' : c.status === 'FAIL' ? '‚úó' : '!'}</div>
                            <div class="check-content">
                                <strong>${c.name}</strong>
                                <span>${c.detail}</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
        
        if (validation.timeline?.milestones) {
            body += `
                <div class="validation-section">
                    <h3>üìÖ Timeline</h3>
                    ${validation.timeline.milestones.map(m => `
                        <div class="timeline-item ${m.critical ? 'critical' : ''}">
                            <div class="timeline-date">${m.date}</div>
                            <div>
                                <div class="timeline-task">${m.task}</div>
                                <div class="timeline-days">${m.daysFromNow > 0 ? m.daysFromNow + ' days away' : 'Past'}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        if (validation.nextSteps?.length) {
            body += `
                <div class="validation-section">
                    <h3>üìå Next Steps</h3>
                    <div class="next-steps">
                        ${validation.nextSteps.map(s => `<div class="next-step">${s}</div>`).join('')}
                    </div>
                </div>
            `;
        }
    }
    
    body += `
        <div style="background: #1a1a1a; padding: 0.5rem; border-radius: 4px;">
            <label style="font-size: 0.6rem; color: var(--gray);">üîó Source Link</label><br>
            ${o.link ? `<a href="${o.link}" target="_blank" style="color: var(--green); font-size: 0.75rem;">${o.link.length > 60 ? o.link.substring(0, 60) + '...' : o.link}</a>` : '<span style="color: var(--gray); font-size: 0.75rem;">No direct link available</span>'}
        </div>
    `;
    
    document.getElementById('modalBody').innerHTML = body;
    
    // Check if Quote button should show
    const quoteBtn = checkQuoteEligibility(o) 
        ? `<button class="btn btn-quote btn-sm" onclick="openQuoteRequest('${o.id}')" title="Prepare a non-binding distributor RFQ for pricing validation.">üìã Request Distributor Quote</button>`
        : '';
    
    const viewSourceBtn = o.link 
        ? `<button class="btn btn-primary" onclick="window.open('${o.link}','_blank')">üîó View Source</button>`
        : `<button class="btn btn-primary" disabled title="No source link available">üîó View Source</button>`;
    
    document.getElementById('modalFooter').innerHTML = `
        ${viewSourceBtn}
        <button class="btn btn-secondary" onclick="runValidation('${o.id}')" ${!o.eligibility.ok?'disabled':''}>üîç Validate</button>
        <button class="btn btn-go btn-sm" onclick="setPipelineStatus('${o.id}','go')" ${!o.eligibility.ok?'disabled':''}>‚úÖ GO</button>
        <button class="btn btn-review btn-sm" onclick="setPipelineStatus('${o.id}','review')">üîç Review</button>
        <button class="btn btn-nogo btn-sm" onclick="setPipelineStatus('${o.id}','nogo')">üö´ No-Go</button>
        ${quoteBtn}
        <button class="btn btn-proposal btn-sm" onclick="goToProposal('${o.id}')" ${!o.eligibility.ok?'disabled':''}>üìù Proposal</button>
        <button class="btn btn-secondary" onclick="closeModal()">Close</button>
    `;
    
    document.getElementById('detailModal').classList.add('active');
}

function closeModal() { document.getElementById('detailModal').classList.remove('active'); }

// NEW: Generate proposal directly from modal
function goToProposal(id) {
    // Set status to GO if not already set
    if (!pipeline[id]?.status || pipeline[id].status === 'review') {
        pipeline[id] = pipeline[id] || {};
        pipeline[id].status = 'go';
        pipeline[id].timestamp = new Date().toISOString();
        safeStorage('pipeline', pipeline);
    }
    
    // Close modal
    closeModal();
    
    // Navigate to AI Agent page
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    document.querySelector('[data-page="agent"]').classList.add('active');
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById('page-agent').classList.add('active');
    
    // Select the opportunity in dropdown
    const sel = document.getElementById('oppSelect');
    sel.value = id;
    
    // Scroll to top
    window.scrollTo({ top: 0, behavior: 'smooth' });
    
    // Auto-generate proposal after short delay
    setTimeout(() => {
        generateProposalForId(id);
    }, 300);
}

// Generate proposal for specific ID (called from modal)
async function generateProposalForId(id) {
    const o = opportunities.find(x => x.id === id);
    if (!o) { alert('Opportunity not found'); return; }
    
    showLoading('Generating proposal...', false);
    log(`Generating proposal for: ${o.title}`, 'info');
    
    try {
        const backendUrl = 'https://singh-automation.vercel.app/api/generate';
        const r = await fetch(backendUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                title: o.title,
                solicitation: o.solicitation || o.noticeId,
                agency: o.agency,
                value: o.value || 350000
            })
        });
        const d = await r.json();
        
        if (d.success) {
            currentProposal = d.proposal;
            document.getElementById('proposalPreview').innerHTML = mdToHtml(d.proposal);
            document.getElementById('proposalOutput').style.display = 'block';
            log(`Proposal generated successfully!`, 'success');
            
            // Highlight output
            const output = document.getElementById('proposalOutput');
            output.style.boxShadow = '0 0 20px rgba(154, 205, 50, 0.4)';
            setTimeout(() => { output.style.boxShadow = 'none'; }, 2000);
        } else {
            throw new Error(d.error || 'Generation failed');
        }
    } catch (e) {
        log('Error: ' + e.message, 'error');
        alert('Proposal generation failed: ' + e.message);
    }
    hideLoading();
}

async function runValidation(id) {
    const o = opportunities.find(x => x.id === id);
    if (!o) return;
    
    showLoading('Running validation agent...', false);
    log('Validating: ' + o.title, 'info');
    
    try {
        const apiKey = document.getElementById('claudeKey').value;
        const backendUrl = document.getElementById('apiUrl').value.replace('/sam', '/validate');
        
        const r = await fetch(backendUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ opportunity: o, claudeApiKey: apiKey })
        });
        
        const d = await r.json();
        
        if (d.success && d.analysis) {
            pipeline[o.id] = {
                status: d.analysis.validation.recommendation.toLowerCase(),
                validation: d.analysis.validation,
                checklist: d.analysis.checklist,
                timeline: d.analysis.timeline,
                timestamp: new Date().toISOString()
            };
            safeStorage('pipeline', pipeline);
            
            log(`Validation complete: ${d.analysis.validation.recommendation}`, 'success');
            showDetail(id); // Refresh modal
            renderOpps();
            updatePipelineStats();
        } else {
            throw new Error(d.error || 'Validation failed');
        }
    } catch (e) {
        log('Validation error: ' + e.message, 'error');
        alert('Validation failed: ' + e.message);
    }
    hideLoading();
}

function setPipelineStatus(id, status) {
    pipeline[id] = pipeline[id] || {};
    pipeline[id].status = status;
    pipeline[id].timestamp = new Date().toISOString();
    safeStorage('pipeline', pipeline);
    
    log(`Set ${id} to ${status.toUpperCase()}`, 'success');
    closeModal();
    renderOpps();
    updatePipelineStats();
    renderQualifiedList();
    updateOppSelect(); // Update dropdown when status changes
}

// ========== PROPOSAL GENERATION ==========
async function generateProposal() {
    const id = document.getElementById('oppSelect').value;
    if (!id) { alert('Select an opportunity'); return; }
    const o = opportunities.find(x => x.id === id || x.noticeId === id);
    if (!o) { alert('Opportunity not found'); return; }
    
    // Get Claude API key if provided
    const claudeKey = document.getElementById('agentClaudeKey')?.value || '';
    
    showLoading(claudeKey ? 'Generating AI proposal with context...' : 'Generating proposal...', false);
    
    try {
        const backendUrl = 'https://singh-automation.vercel.app/api/generate';
        const r = await fetch(backendUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                title: o.title,
                solicitation: o.solicitation || o.noticeId,
                agency: o.agency,
                value: o.value || 350000,
                naics: o.naicsCode || '',
                setAside: o.setAside || '',
                description: o.description || '',
                category: o.category || 'Federal',
                claudeKey: claudeKey || null
            })
        });
        const d = await r.json();
        
        if (d.success) {
            currentProposal = d.proposal;
            
            // Build the preview HTML
            let previewHtml = '';
            
            // Show context used (if any)
            if (d.contextUsed && d.contextUsed.length > 0) {
                previewHtml += `<div class="context-summary">
                    <strong>üìö Context Used:</strong> ${d.contextUsed.join(' ‚Ä¢ ')}
                </div>`;
            }
            
            // Show the proposal
            previewHtml += mdToHtml(d.proposal);
            
            // Show compliance checklist (if any)
            if (d.complianceChecklist && d.complianceChecklist.length > 0) {
                previewHtml += `<div class="compliance-checklist">
                    <h3>‚úÖ Compliance Checklist</h3>
                    <ul>${d.complianceChecklist.map(c => 
                        `<li>${c.status} ${c.item}</li>`
                    ).join('')}</ul>
                </div>`;
            }
            
            // Show generation info
            if (d.method === 'claude-ai') {
                previewHtml += `<div class="gen-info">
                    <small>Generated with Claude AI ‚Ä¢ Tokens: ${d.tokensUsed?.input || 0} in / ${d.tokensUsed?.output || 0} out ‚Ä¢ Est. cost: ${d.estimatedCost || 'N/A'}</small>
                </div>`;
            }
            
            document.getElementById('proposalPreview').innerHTML = previewHtml;
            document.getElementById('proposalOutput').style.display = 'block';
            log(`Proposal generated (${d.method})${d.estimatedCost ? ' - ' + d.estimatedCost : ''}`, 'success');
        } else {
            throw new Error(d.error || 'Unknown error');
        }
    } catch (e) {
        log('Error: ' + e.message, 'error');
        console.error(e);
        alert('Proposal generation failed: ' + e.message);
    }
    hideLoading();
}

async function downloadProposal() {
    const select = document.getElementById('oppSelect');
    if (!select || !select.value) { alert('Select an opportunity first'); return; }
    
    const opp = opportunities.find(o => o.id === select.value || o.noticeId === select.value);
    if (!opp) { alert('Opportunity not found'); return; }
    
    if (!currentProposal) {
        alert('Please generate a proposal first');
        return;
    }
    
    log('Creating Word document...', 'info');
    
    const html = `
        <html xmlns:o="urn:schemas-microsoft-com:office:office" 
              xmlns:w="urn:schemas-microsoft-com:office:word"
              xmlns="http://www.w3.org/TR/REC-html40">
        <head>
            <meta charset="utf-8">
            <title>Singh Automation Proposal</title>
            <style>
                body { font-family: Arial, sans-serif; font-size: 11pt; line-height: 1.6; margin: 1in; }
                h1 { color: #1B4F72; font-size: 18pt; border-bottom: 2px solid #1B4F72; padding-bottom: 5pt; margin-top: 24pt; }
                h2 { color: #2E86AB; font-size: 14pt; margin-top: 18pt; }
                h3 { color: #333; font-size: 12pt; margin-top: 12pt; }
                table { border-collapse: collapse; width: 100%; margin: 12pt 0; }
                th, td { border: 1px solid #ccc; padding: 8pt; text-align: left; }
                th { background-color: #1B4F72; color: white; }
                ul, ol { margin-left: 20pt; }
                p { margin: 6pt 0; }
            </style>
        </head>
        <body>${mdToHtml(currentProposal)}</body>
        </html>
    `;
    const blob = new Blob([html], { type: 'application/msword' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `Singh_Proposal_${opp.title.replace(/[^a-zA-Z0-9]/g, '_').substring(0, 30)}.doc`;
    a.click();
    log('Word document downloaded!', 'success');
}

// Download TXT
function downloadTXT() {
    if (!currentProposal) {
        alert('Please generate a proposal first');
        return;
    }
    
    const select = document.getElementById('oppSelect');
    const opp = opportunities.find(o => o.id === select.value || o.noticeId === select.value);
    const filename = opp ? opp.title.replace(/[^a-zA-Z0-9]/g, '_').substring(0, 30) : 'Proposal';
    
    const blob = new Blob([currentProposal], { type: 'text/plain' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `Singh_Proposal_${filename}.txt`;
    a.click();
    log('TXT file downloaded!', 'success');
}

function mdToHtml(md) {
    return md
        .replace(/^### (.*)$/gm, '<h3>$1</h3>')
        .replace(/^## (.*)$/gm, '<h2>$1</h2>')
        .replace(/^# (.*)$/gm, '<h1>$1</h1>')
        .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
        .replace(/^\| (.+) \|$/gm, (match, content) => {
            const cells = content.split(' | ').map(c => `<td>${c.trim()}</td>`).join('');
            return `<tr>${cells}</tr>`;
        })
        .replace(/^\|[-\s|]+\|$/gm, '') // Remove table separator lines
        .replace(/(<tr>[\s\S]*?<\/tr>)+/g, '<table border="1">$&</table>')
        .replace(/^- (.+)$/gm, '<li>$1</li>')
        .replace(/(<li>[\s\S]*?<\/li>)+/g, '<ul>$&</ul>')
        .replace(/^\d+\. (.+)$/gm, '<li>$1</li>')
        .replace(/\n\n/g, '</p><p>')
        .replace(/^---$/gm, '<hr>')
        .replace(/\n/g, '<br>');
}

// ========== SETTINGS ==========
function loadSettings() {
    try {
        const api = localStorage.getItem('apiUrl');
        const key = localStorage.getItem('claudeKey');
        const revenueGoal = localStorage.getItem('revenueGoal');
        const winRate = localStorage.getItem('winRate');
        
        if (api) document.getElementById('apiUrl').value = api;
        if (key) {
            document.getElementById('claudeKey').value = key;
            document.getElementById('agentClaudeKey').value = key;
        }
        if (revenueGoal) document.getElementById('revenueGoal').value = revenueGoal;
        if (winRate) document.getElementById('winRate').value = winRate;
        
        // Add listeners to save settings - use both input and change for robustness
        const apiInput = document.getElementById('apiUrl');
        if (apiInput) {
            apiInput.addEventListener('input', function() { safeStorage('apiUrl', this.value); });
            apiInput.addEventListener('change', function() { safeStorage('apiUrl', this.value); });
            apiInput.addEventListener('blur', function() { safeStorage('apiUrl', this.value); });
        }
        document.getElementById('revenueGoal')?.addEventListener('change', function() {
            safeStorage('revenueGoal', this.value);
        });
        document.getElementById('winRate')?.addEventListener('change', function() {
            safeStorage('winRate', this.value);
        });
    } catch (e) {
        console.warn('localStorage unavailable:', e);
        log('Settings persistence unavailable (private browsing?)', 'info');
    }
}

// Safe localStorage wrapper
function safeStorage(key, value) {
    try {
        if (value === null || value === undefined) {
            localStorage.removeItem(key);
        } else if (typeof value === 'object') {
            localStorage.setItem(key, JSON.stringify(value));
        } else {
            localStorage.setItem(key, value);
        }
        return true;
    } catch (e) {
        console.warn('localStorage write failed:', e);
        return false;
    }
}

function safeStorageGet(key, defaultValue = null) {
    try {
        const val = localStorage.getItem(key);
        if (val === null) return defaultValue;
        try { return JSON.parse(val); } catch { return val; }
    } catch (e) {
        console.warn('localStorage read failed:', e);
        return defaultValue;
    }
}

function setupKeySync() {
    // Sync header key to agent key and save
    document.getElementById('claudeKey').addEventListener('input', function() {
        document.getElementById('agentClaudeKey').value = this.value;
        safeStorage('claudeKey', this.value);
    });
    // Sync agent key to header key and save
    document.getElementById('agentClaudeKey').addEventListener('input', function() {
        document.getElementById('claudeKey').value = this.value;
        safeStorage('claudeKey', this.value);
    });
}

// ========== EVENTS ==========
document.addEventListener('click', e => {
    if (e.target.classList.contains('nav-btn')) {
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById('page-' + e.target.dataset.page).classList.add('active');
    }
    if (e.target.classList.contains('tab') && e.target.dataset.tab) {
        currentTab = e.target.dataset.tab;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        e.target.classList.add('active');
        renderOpps();
    }
    if (e.target.classList.contains('filter-pill') && e.target.dataset.filter) {
        currentFilter = e.target.dataset.filter;
        document.querySelectorAll('.filter-pill[data-filter]').forEach(p => p.classList.remove('active'));
        e.target.classList.add('active');
        renderOpps();
    }
    if (e.target.closest('.opp-card')) {
        const card = e.target.closest('.opp-card');
        if (card.dataset.id) showDetail(card.dataset.id);
    }
});

document.getElementById('searchInput')?.addEventListener('keyup', renderOpps);

// ========== SUBCONTRACTING ==========
let subOpportunities = [];
let currentSubFilter = 'all';

// ========== PURCHASING PAGE ==========
let purchasingOpportunities = [];
let currentPurchFilter = 'all';

async function loadPurchasing() {
    const list = document.getElementById('purchasingList');
    list.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--gray);"><div class="spinner"></div><p>Analyzing opportunities...</p></div>';
    
    // If no opportunities loaded, scan first
    if (opportunities.length === 0) {
        await scanAll();
    }
    
    // Analyze all opportunities for purchasing eligibility
    purchasingOpportunities = opportunities.map(o => ({
        ...o,
        purchasing: analyzePurchasingEligibility(o)
    })).filter(o => o.purchasing.eligible);
    
    // Sort by match score
    purchasingOpportunities.sort((a, b) => b.matchScore - a.matchScore);
    
    updatePurchasingStats();
    renderPurchasing();
}

function updatePurchasingStats() {
    const total = purchasingOpportunities.length;
    const plc = purchasingOpportunities.filter(o => o.purchasing.category === 'PLC/Controls').length;
    const robotics = purchasingOpportunities.filter(o => o.purchasing.category === 'Robotics').length;
    const vision = purchasingOpportunities.filter(o => o.purchasing.category === 'Vision/Sensors').length;
    const motion = purchasingOpportunities.filter(o => o.purchasing.category === 'Motion/VFD').length;
    
    document.getElementById('purchTotal').textContent = total;
    document.getElementById('purchPLC').textContent = plc;
    document.getElementById('purchRobotics').textContent = robotics;
    document.getElementById('purchVision').textContent = vision;
    document.getElementById('purchMotion').textContent = motion;
}

function filterPurchasing(filter, btn) {
    currentPurchFilter = filter;
    document.querySelectorAll('[data-purchfilter]').forEach(el => el.classList.remove('active'));
    btn.classList.add('active');
    renderPurchasing();
}

function renderPurchasing() {
    const list = document.getElementById('purchasingList');
    
    let filtered = purchasingOpportunities;
    if (currentPurchFilter !== 'all') {
        filtered = purchasingOpportunities.filter(o => o.purchasing.category === currentPurchFilter);
    }
    
    if (filtered.length === 0) {
        list.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--gray);"><p>No opportunities found for this category</p></div>';
        return;
    }
    
    list.innerHTML = filtered.map(o => {
        const catColors = {
            'PLC/Controls': { bg: 'rgba(59,130,246,0.2)', color: '#60a5fa' },
            'Robotics': { bg: 'rgba(139,92,246,0.2)', color: '#a78bfa' },
            'Vision/Sensors': { bg: 'rgba(16,185,129,0.2)', color: '#34d399' },
            'Motion/VFD': { bg: 'rgba(245,158,11,0.2)', color: '#fbbf24' },
            'Mixed': { bg: 'rgba(154,205,50,0.2)', color: 'var(--green)' },
            'Unknown': { bg: 'rgba(100,100,100,0.2)', color: '#888' }
        };
        const catStyle = catColors[o.purchasing.category] || catColors['Unknown'];
        const scoreClass = o.matchScore >= 70 ? '' : o.matchScore >= 50 ? 'medium' : 'low';
        
        return `
        <div class="opp-card qualified" data-id="${o.id}">
            <div class="opp-header">
                <div class="opp-title">${o.title}</div>
                <div class="match-score ${scoreClass}">${o.matchScore}%</div>
            </div>
            <div class="opp-meta">
                <span>üèõÔ∏è ${(o.agency||'Agency').substring(0,35)}</span>
                <span>üí∞ ${fmtCurrency(o.value)}</span>
                <span>üìÖ ${fmtDate(o.closeDate)}</span>
            </div>
            <div class="opp-desc">${(o.description||'').substring(0,120)}...</div>
            <div style="display: flex; gap: 0.5rem; align-items: center; margin-top: 0.5rem; flex-wrap: wrap;">
                <span style="background: ${catStyle.bg}; color: ${catStyle.color}; padding: 0.2rem 0.6rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600;">
                    üõí ${o.purchasing.category}
                </span>
                <span style="font-size: 0.7rem; color: var(--gray);">${o.purchasing.reason}</span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid var(--border);">
                ${o.link ? `<a href="${o.link}" target="_blank" style="font-size: 0.7rem; color: var(--green);">View Source ‚Üí</a>` : '<span style="font-size: 0.7rem; color: var(--gray);">No direct link</span>'}
                ${o.matchScore >= 65 ? `<button class="btn btn-sm btn-quote" onclick="event.stopPropagation(); openQuoteRequest('${o.id}')">üìã Request Quote</button>` : ''}
            </div>
        </div>
        `;
    }).join('');
}

async function loadSubcontracting() {
    const list = document.getElementById('subList');
    list.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--gray);"><div class="loading-spinner"></div><p>Loading opportunities...</p></div>';
    
    try {
        const response = await fetch('/api/subcontracting');
        if (response.ok) {
            const data = await response.json();
            if (data.success && data.opportunities?.length > 0) {
                subOpportunities = data.opportunities;
                document.getElementById('subSource').innerHTML = 'üü¢ Live';
                document.getElementById('subSource').style.color = 'var(--green)';
                renderSubOpportunities();
                return;
            }
        }
    } catch(e) {
        console.log('Subcontracting API unavailable, using demo');
    }
    
    // Fallback to demo data
    subOpportunities = getSubDemoData();
    document.getElementById('subSource').innerHTML = 'üìä Demo';
    document.getElementById('subSource').style.color = 'var(--orange)';
    renderSubOpportunities();
}

function getSubDemoData() {
    return [
        { id: 'SUB-001', prime: 'Turner Construction', award_amount: 8200000, agency: 'Army Corps of Engineers', description: 'Military base modernization with automated material handling systems', location: 'Fort Liberty, NC', naics: '236220', match_score: 87, tier: 'hot', signals: ['automation scope', 'material handling', 'DoD prime'], contact: { email: 'subcontracting@turnerconstruction.com', portal: 'https://www.turnerconstruction.com/subcontractors' }, contract_link: 'https://usaspending.gov/award/CONT_AWD_W912DY24C0001' },
        { id: 'SUB-002', prime: 'Hensel Phelps', award_amount: 12400000, agency: 'Department of Veterans Affairs', description: 'VA hospital renovation including robotic pharmacy and logistics systems', location: 'San Diego, CA', naics: '236220', match_score: 84, tier: 'hot', signals: ['robotic pharmacy', 'logistics automation', 'healthcare'], contact: { email: 'suppliers@henselphelps.com', portal: 'https://www.henselphelps.com/subcontractors/' }, contract_link: 'https://usaspending.gov/award/CONT_AWD_36C24624C0002' },
        { id: 'SUB-003', prime: 'Clark Construction', award_amount: 6800000, agency: 'GSA', description: 'Federal building upgrade with smart building automation', location: 'Chicago, IL', naics: '236220', match_score: 78, tier: 'hot', signals: ['building automation', 'smart systems', 'controls'], contact: { email: 'subcontractors@clarkconstruction.com', portal: 'https://www.clarkconstruction.com/subcontractors' }, contract_link: 'https://usaspending.gov/award/CONT_AWD_GS09P24BTC0003' },
        { id: 'SUB-004', prime: 'Leidos', award_amount: 5700000, agency: 'DoD', description: 'Defense logistics automation and AI systems integration', location: 'Huntsville, AL', naics: '541512', match_score: 62, tier: 'warm', signals: ['AI integration', 'logistics', 'defense'], contact: { email: 'small.business@leidos.com', portal: 'https://www.leidos.com/suppliers' }, contract_link: 'https://usaspending.gov/award/CONT_AWD_W58RGZ24C0004' },
        { id: 'SUB-005', prime: 'Jacobs Engineering', award_amount: 4800000, agency: 'NASA', description: 'Facility systems integration for launch complex', location: 'Cape Canaveral, FL', naics: '541330', match_score: 58, tier: 'warm', signals: ['systems integration', 'NASA', 'facility automation'], contact: { email: 'supplier.diversity@jacobs.com', portal: 'https://www.jacobs.com/suppliers' }, contract_link: 'https://usaspending.gov/award/CONT_AWD_NNK24MA0005' },
        { id: 'SUB-006', prime: 'KBR Inc', award_amount: 6100000, agency: 'Army', description: 'Base infrastructure modernization project', location: 'Fort Hood, TX', naics: '541330', match_score: 55, tier: 'warm', signals: ['infrastructure', 'modernization', 'DoD'], contact: { email: 'supplierdiversity@kbr.com', portal: 'https://www.kbr.com/en/about-us/suppliers' }, contract_link: 'https://usaspending.gov/award/CONT_AWD_W911KB24C0006' },
        { id: 'SUB-007', prime: 'AECOM', award_amount: 3200000, agency: 'Air Force', description: 'Hangar facility improvements', location: 'Edwards AFB, CA', naics: '236220', match_score: 42, tier: 'cold', signals: ['facility', 'Air Force'], contact: { email: 'suppliers@aecom.com', portal: 'https://aecom.com/about-aecom/suppliers/' }, contract_link: 'https://usaspending.gov/award/CONT_AWD_FA930824C0007' },
        { id: 'SUB-008', prime: 'Parsons Corporation', award_amount: 5200000, agency: 'DHS', description: 'Border security technology systems', location: 'El Paso, TX', naics: '541512', match_score: 38, tier: 'cold', signals: ['security systems', 'technology'], contact: { email: 'suppliers@parsons.com', portal: 'https://www.parsons.com/suppliers/' }, contract_link: 'https://usaspending.gov/award/CONT_AWD_HSBP1024C0008' }
    ];
}

function renderSubOpportunities() {
    const list = document.getElementById('subList');
    let filtered = subOpportunities;
    
    if (currentSubFilter !== 'all') {
        filtered = subOpportunities.filter(o => (o.tier || o.priority || 'warm') === currentSubFilter);
    }
    
    if (filtered.length === 0) {
        list.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--gray);"><p>No opportunities found</p></div>';
        return;
    }
    
    list.innerHTML = filtered.map(opp => {
        // Normalize field names - handle both API formats
        const prime = opp.prime || opp.recipient_name || opp.recipientName || opp.prime_contractor || opp.Recipient_Name || 'Unknown Prime';
        const amount = opp.award_amount || opp.awardAmount || opp.Award_Amount || opp.total_obligation || opp.amount || 0;
        const agency = opp.agency || opp.awarding_agency || opp.Awarding_Agency || opp.funding_agency || 'Federal Agency';
        const desc = opp.description || opp.Description || opp.award_description || 'Contract award - potential subcontracting opportunity';
        const loc = opp.location || opp.place_of_performance || opp.recipient_location || opp.Place_of_Performance || '';
        const naicsCode = opp.naics || opp.naics_code || opp.naicsCode || opp.NAICS || opp.naics_description || '';
        const score = opp.match_score || opp.score || opp.relevance_score || 75;
        const tier = opp.tier || opp.priority || (score >= 70 ? 'hot' : score >= 50 ? 'warm' : 'cold');
        const signals = opp.signals || opp.keywords || opp.tags || ['federal contract'];
        const contractLink = opp.contract_link || opp.usaspending_link || opp.usaSpendingUrl || opp.award_link || (opp.generated_internal_id ? `https://usaspending.gov/award/${opp.generated_internal_id}` : 'https://usaspending.gov');
        const contactEmail = opp.contact?.email || opp.email || '';
        
        const tierClass = tier === 'hot' ? 'background: var(--red);' : tier === 'warm' ? 'background: var(--orange);' : 'background: var(--gray);';
        const tierColor = tier === 'hot' || tier === 'cold' ? 'color: #fff;' : 'color: #000;';
        const amountDisplay = amount >= 1000000 ? `$${(amount / 1000000).toFixed(1)}M` : `$${(amount / 1000).toFixed(0)}K`;
        
        return `
        <div class="opp-card qualified">
            <div class="opp-header">
                <div class="opp-title">${prime}</div>
                <div class="opp-type" style="position: absolute; right: 0.75rem; top: 0.75rem; ${tierClass} ${tierColor}">
                    ${score}%
                </div>
            </div>
            <div class="opp-meta">
                <span>üèõÔ∏è ${agency}</span>
                <span>üí∞ ${amountDisplay}</span>
                <span>üìç ${loc || 'USA'}</span>
                <span>üìã ${naicsCode || 'N/A'}</span>
            </div>
            <div class="opp-desc">${desc}</div>
            <div class="opp-tags">
                <span class="tag" style="${tierClass} ${tierColor}">${tier.toUpperCase()}</span>
                ${Array.isArray(signals) ? signals.slice(0,4).map(s => `<span class="tag">${s}</span>`).join('') : `<span class="tag">${signals}</span>`}
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid var(--border);">
                <a href="${contractLink}" target="_blank" style="font-size: 0.7rem; color: var(--green);">View on USASpending ‚Üí</a>
                <button class="btn btn-sm btn-primary" onclick="showSubOutreach(${subOpportunities.indexOf(opp)})">üìß Draft Outreach</button>
            </div>
        </div>
        `;
    }).join('');
}

function filterSubs(filter, btn) {
    currentSubFilter = filter;
    document.querySelectorAll('[data-subfilter]').forEach(el => el.classList.remove('active'));
    btn.classList.add('active');
    renderSubOpportunities();
}

function showSubOutreach(idx) {
    const opp = subOpportunities[idx];
    
    // Normalize field names
    const prime = opp.prime || opp.recipient_name || opp.recipientName || opp.prime_contractor || 'Prime Contractor';
    const agency = opp.agency || opp.awarding_agency || opp.funding_agency || 'Federal Agency';
    const desc = opp.description || opp.award_description || 'federal contract';
    const contactEmail = opp.contact?.email || opp.email || '';
    
    const email = generateSubEmail({ prime, agency, description: desc });
    
    // Create modal for outreach
    const modal = document.createElement('div');
    modal.id = 'outreachModal';
    modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 1000; display: flex; justify-content: center; align-items: center; padding: 1rem;';
    modal.innerHTML = `
        <div class="outreach-content" style="background: var(--card); border: 1px solid var(--border); border-radius: 12px; width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; border-bottom: 1px solid var(--border);">
                <h3 style="font-size: 1rem;">üìß Outreach to ${prime}</h3>
                <button class="close-outreach-btn" style="background: none; border: none; color: var(--gray); font-size: 1.5rem; cursor: pointer; padding: 0.25rem 0.5rem;">&times;</button>
            </div>
            <div style="padding: 1rem;">
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; font-size: 0.75rem; color: var(--gray); margin-bottom: 0.25rem;">To:</label>
                    <input type="text" id="outreachTo" value="${contactEmail}" style="width: 100%; padding: 0.5rem; background: var(--dark); border: 1px solid var(--border); border-radius: 4px; color: #fff;">
                </div>
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; font-size: 0.75rem; color: var(--gray); margin-bottom: 0.25rem;">Subject:</label>
                    <input type="text" id="outreachSubject" value="Singh Automation - Subcontracting Inquiry: ${opp.agency} Project" style="width: 100%; padding: 0.5rem; background: var(--dark); border: 1px solid var(--border); border-radius: 4px; color: #fff;">
                </div>
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; font-size: 0.75rem; color: var(--gray); margin-bottom: 0.25rem;">Body:</label>
                    <textarea id="outreachBody" style="width: 100%; min-height: 280px; padding: 0.75rem; background: var(--dark); border: 1px solid var(--border); border-radius: 4px; color: #fff; font-family: inherit; line-height: 1.5; resize: vertical;">${email}</textarea>
                </div>
            </div>
            <div style="display: flex; gap: 0.5rem; justify-content: flex-end; padding: 1rem; border-top: 1px solid var(--border);">
                <button class="btn btn-secondary close-outreach-btn">Close</button>
                <button class="btn btn-secondary" onclick="copyOutreachEmail()">üìã Copy</button>
                <button class="btn btn-primary" onclick="openOutreachEmail()">üìß Open in Email</button>
            </div>
        </div>
    `;
    
    // Close handlers
    modal.querySelectorAll('.close-outreach-btn').forEach(btn => {
        btn.addEventListener('click', () => modal.remove());
    });
    modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
    });
    
    document.body.appendChild(modal);
}

function generateSubEmail(opp) {
    return `Dear ${opp.prime} Team,

I noticed your company was recently awarded a contract with ${opp.agency} involving ${opp.description.toLowerCase()}.

Singh Automation is a FANUC and Universal Robots authorized integrator specializing in industrial robotics and automation systems. If your team needs support executing the robotics, automation, or vision systems portion of this contract, we'd welcome the opportunity to discuss teaming.

Our qualifications:
‚Ä¢ FANUC Authorized System Integrator (ASI)
‚Ä¢ Universal Robots Certified System Partner (CSP)
‚Ä¢ CAGE Code: 86VF7 | UEI: GJ1DPYQ3X8K5
‚Ä¢ Certified Small Business, MBE, WBENC
‚Ä¢ NAICS: 333249, 541330, 541512, 541715

We have facilities in both Michigan and California and can mobilize quickly for projects nationwide.

Would you be available for a brief call this week to explore potential collaboration?

Best regards,

Singh Automation
www.singhautomation.com
(269) 381-6236
2400 E Cork Street, Kalamazoo, MI 49001`;
}

function copyOutreachEmail() {
    const subject = document.getElementById('outreachSubject').value;
    const body = document.getElementById('outreachBody').value;
    navigator.clipboard.writeText(`Subject: ${subject}\n\n${body}`).then(() => alert('Copied to clipboard!'));
}

function openOutreachEmail() {
    const to = document.getElementById('outreachTo').value;
    const subject = encodeURIComponent(document.getElementById('outreachSubject').value);
    const body = encodeURIComponent(document.getElementById('outreachBody').value);
    window.open(`mailto:${to}?subject=${subject}&body=${body}`, '_blank');
}

// ========== EMAIL ALERTS ==========
async function subscribeAlerts() {
    const email = document.getElementById('alertEmail').value;
    const frequency = document.getElementById('alertFreq').value;
    
    if (!email || !email.includes('@')) {
        alert('Please enter a valid email address');
        return;
    }
    
    try {
        const backendUrl = document.getElementById('apiUrl').value;
        const r = await fetch(backendUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                email,
                frequency,
                filters: {
                    federal: true,
                    sbir: true,
                    state: true,
                    dibbs: true,
                    minValue: 50000,
                    naicsCodes: ['333249', '333922', '541330', '541512', '541715', '238210']
                }
            })
        });
        const data = await r.json();
        
        if (data.success) {
            log(`‚úÖ Subscribed ${email} for ${frequency} alerts`, 'success');
            alert(`Success! You'll receive ${frequency} alerts at ${email}`);
            document.getElementById('alertEmail').value = '';
        } else {
            throw new Error(data.error);
        }
    } catch (e) {
        log('Email subscription failed: ' + e.message, 'error');
        alert('Subscription failed. Please try again.');
    }
}

// ========== CATEGORY BADGES ==========
function getCategoryBadge(type) {
    const badges = {
        'contract': '<span class="badge" style="background: #1a5f7a;">Federal</span>',
        'sbir': '<span class="badge" style="background: #7b2cbf;">SBIR</span>',
        'state': '<span class="badge" style="background: #2d6a4f;">State</span>',
        'dibbs': '<span class="badge" style="background: #9c6644;">DIBBS</span>',
        'forecast': '<span class="badge" style="background: #555;">Forecast</span>'
    };
    return badges[type] || '';
}

function getTypeBadgeColor(type) {
    const colors = {
        'contract': { bg: '#1a5f7a', color: '#fff' },
        'sbir': { bg: '#7b2cbf', color: '#fff' },
        'state': { bg: '#2d6a4f', color: '#fff' },
        'dibbs': { bg: '#9c6644', color: '#fff' },
        'forecast': { bg: '#555', color: '#ccc' }
    };
    return colors[type] || { bg: '#1a5f7a', color: '#fff' };
}

// ========== DISTRIBUTOR QUOTE REQUEST FEATURE ==========
const QUOTE_AUTOMATION_KEYWORDS = [
    'plc', 'hmi', 'controls', 'controller', 'vfd', 'servo', 'motion', 
    'drive', 'sensor', 'vision', 'camera', 'robot', 'robotic', 'fanuc', 
    'universal robot', 'cobot', 'eoat', 'gripper', 'automation', 
    'conveyor', 'actuator', 'encoder', 'motor', 'pneumatic', 'valve'
];

// ========== PURCHASING ELIGIBILITY ANALYSIS ==========
function analyzePurchasingEligibility(o) {
    const text = ((o.title || '') + ' ' + (o.description || '')).toLowerCase();
    
    // Category keywords
    const categories = {
        'PLC/Controls': ['plc', 'hmi', 'scada', 'control panel', 'controls', 'controller', 'programmable logic'],
        'Robotics': ['robot', 'robotic', 'manipulator', 'cobot', 'fanuc', 'universal robot', 'kuka', 'abb robot', 'yaskawa'],
        'Vision/Sensors': ['vision', 'camera', 'sensor', 'inspection', 'machine vision', 'barcode', 'scanner', 'detection'],
        'Motion/VFD': ['vfd', 'servo', 'drive', 'motor', 'actuator', 'motion control', 'encoder', 'inverter'],
        'Safety': ['safety', 'light curtain', 'e-stop', 'safety relay', 'interlock'],
        'EOAT': ['eoat', 'gripper', 'end effector', 'tooling', 'end-of-arm']
    };
    
    // Services-only indicators
    const servicesOnly = ['consulting', 'advisory', 'study', 'assessment', 'audit', 'training only', 'staffing', 'labor hours', 'professional services'];
    
    // Check if services-only
    const isServicesOnly = servicesOnly.some(s => text.includes(s)) && 
                          !['equipment', 'hardware', 'system', 'install', 'robot', 'plc', 'sensor'].some(h => text.includes(h));
    
    if (isServicesOnly) {
        return {
            eligible: false,
            category: 'Unknown',
            reason: 'Opportunity appears to be services or consulting only.'
        };
    }
    
    // Find matching categories
    const matchedCategories = [];
    for (const [cat, keywords] of Object.entries(categories)) {
        if (keywords.some(kw => text.includes(kw))) {
            matchedCategories.push(cat);
        }
    }
    
    // Determine category
    let category = 'Unknown';
    let reason = '';
    
    if (matchedCategories.length === 0) {
        // Check for general automation/hardware terms
        const generalHardware = ['equipment', 'hardware', 'system', 'upgrade', 'replacement', 'install', 'automation'];
        if (generalHardware.some(h => text.includes(h))) {
            category = 'Mixed';
            reason = 'Opportunity references automation equipment or hardware.';
            return { eligible: true, category, reason };
        }
        // Default to YES when uncertain per spec
        return {
            eligible: true,
            category: 'Unknown',
            reason: 'Category unclear but automation context suggests potential hardware.'
        };
    } else if (matchedCategories.length === 1) {
        category = matchedCategories[0];
        reason = `Opportunity includes ${category.toLowerCase()} hardware or components.`;
    } else {
        category = 'Mixed';
        reason = `Opportunity includes ${matchedCategories.slice(0, 2).join(' and ').toLowerCase()} equipment.`;
    }
    
    return {
        eligible: true,
        category,
        reason
    };
}

function checkQuoteEligibility(o) {
    // Check 1: Score >= 65%
    const score = o.matchScore || o.match_score || 0;
    if (score < 65) return false;
    
    // Check 2: Has automation keywords
    const text = ((o.title || '') + ' ' + (o.description || '')).toLowerCase();
    const hasAutomation = QUOTE_AUTOMATION_KEYWORDS.some(kw => text.includes(kw));
    if (!hasAutomation) return false;
    
    // Check 3: Pre-award (not post-award)
    const type = (o.type || o.noticeType || '').toLowerCase();
    if (type.includes('award') && !type.includes('pre')) return false;
    
    return true;
}

function openQuoteRequest(id) {
    const o = opportunities.find(x => x.id === id);
    if (!o) { alert('Opportunity not found'); return; }
    
    // Close detail modal first
    closeModal();
    
    // Generate quote data
    const quoteData = generateQuoteData(o);
    
    // Show quote modal
    showQuoteModal(o, quoteData);
}

function generateQuoteData(o) {
    const desc = (o.description || '').toLowerCase();
    const title = (o.title || '').toLowerCase();
    const combined = desc + ' ' + title;
    
    // Extract line items with price lookups
    const lineItems = [];
    const keywordMap = {
        'plc': { category: 'plc', classification: 'Distributor-sourcable', classKey: 'dist' },
        'hmi': { category: 'hmi', classification: 'Distributor-sourcable', classKey: 'dist' },
        'vfd': { category: 'vfd', classification: 'Distributor-sourcable', classKey: 'dist' },
        'servo': { category: 'servo', classification: 'Distributor-sourcable', classKey: 'dist' },
        'robot': { category: 'robot', classification: 'Integrator-required', classKey: 'integ' },
        'vision': { category: 'vision', classification: 'Distributor-sourcable', classKey: 'dist' },
        'automation': { category: null, classification: 'Integrator-required', classKey: 'integ' },
        'conveyor': { category: null, classification: 'Integrator-required', classKey: 'integ' },
        'sensor': { category: 'vision', classification: 'Distributor-sourcable', classKey: 'dist' },
        'controller': { category: 'plc', classification: 'Distributor-sourcable', classKey: 'dist' },
        'motor': { category: 'servo', classification: 'Distributor-sourcable', classKey: 'dist' },
        'drive': { category: 'vfd', classification: 'Distributor-sourcable', classKey: 'dist' },
        'fanuc': { category: 'robot', classification: 'Integrator-required', classKey: 'integ' },
        'universal robot': { category: 'robot', classification: 'Integrator-required', classKey: 'integ' },
        'cobot': { category: 'robot', classification: 'Integrator-required', classKey: 'integ' }
    };
    
    Object.entries(keywordMap).forEach(([kw, config]) => {
        if (combined.includes(kw)) {
            // Look up suggested products from catalog
            const catalogItems = config.category ? (PRICE_CATALOG[config.category] || []) : [];
            const suggestedProduct = catalogItems.length > 0 ? catalogItems[0] : null;
            
            // Estimate quantity based on contract value
            const estimatedValue = parseFloat(o.value) || 0;
            let estimatedQty = 'TBD';
            if (suggestedProduct && estimatedValue > 0) {
                const roughQty = Math.max(1, Math.floor(estimatedValue * 0.3 / suggestedProduct.price)); // Assume 30% is material
                estimatedQty = roughQty > 10 ? '~' + roughQty : roughQty.toString();
            }
            
            lineItems.push({
                description: `${kw.toUpperCase()} system/components`,
                quantity: estimatedQty,
                classification: config.classification,
                classKey: config.classKey,
                confidence: suggestedProduct ? 'High' : 'Medium',
                notes: suggestedProduct ? `Suggested: ${suggestedProduct.name}` : 'Verify specific requirements',
                suggestedProduct,
                catalogOptions: catalogItems
            });
        }
    });
    
    // Calculate estimated material cost
    let estimatedMaterialCost = 0;
    lineItems.forEach(item => {
        if (item.suggestedProduct && item.quantity !== 'TBD') {
            const qty = parseInt(item.quantity.replace('~', '')) || 1;
            estimatedMaterialCost += item.suggestedProduct.price * qty;
        }
    });
    
    // Missing fields
    const missingFields = [];
    if (!o.solicitation && !o.noticeId) missingFields.push('Solicitation Number');
    if (!o.closeDate) missingFields.push('Due Date');
    if (!o.placeOfPerformance && !o.location) missingFields.push('Delivery Location');
    if (lineItems.length === 0) missingFields.push('Specific Line Items');
    
    // Confidence score
    let confidence = 50;
    if (lineItems.length > 0) confidence += 20;
    if (missingFields.length <= 2) confidence += 15;
    if (o.closeDate && daysUntil(o.closeDate) > 14) confidence += 10;
    if (estimatedMaterialCost > 0) confidence += 5;
    confidence = Math.min(90, confidence);
    
    return { lineItems, missingFields, confidence, estimatedMaterialCost };
}

function showQuoteModal(o, data) {
    const today = new Date().toISOString().split('T')[0];
    const confLevel = data.confidence >= 70 ? 'High' : data.confidence >= 50 ? 'Medium' : 'Low';
    const confColor = data.confidence >= 70 ? 'var(--green)' : data.confidence >= 50 ? 'var(--orange)' : 'var(--red)';
    
    const rfqDraft = generateRFQDraft(o, data);
    
    const modal = document.createElement('div');
    modal.id = 'quoteRequestModal';
    modal.innerHTML = `
        <div class="quote-modal">
            <div class="quote-modal-header">
                <div>
                    <h2 style="font-size: 1.1rem; color: var(--green); margin: 0;">üìã Distributor Quote Request</h2>
                    <p style="font-size: 0.75rem; color: var(--gray); margin: 0.25rem 0 0 0;">Pre-Award Pricing Validation Draft</p>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 0.7rem; color: var(--gray);">Fulfillment Confidence</div>
                    <div style="font-size: 1.25rem; font-weight: 700; color: ${confColor};">${data.confidence}% ${confLevel}</div>
                </div>
            </div>
            
            <div class="quote-modal-body">
                <div class="quote-warning">
                    <div style="display: flex; align-items: center; gap: 0.5rem; color: var(--orange); font-weight: 600;">
                        ‚ö†Ô∏è FOR PRICING VALIDATION ONLY
                    </div>
                    <p style="color: #d4a100; margin: 0.5rem 0 0 0; font-size: 0.8rem;">
                        This is a draft RFQ. No purchase order is authorized. Human approval required before sending.
                    </p>
                </div>
                
                ${data.missingFields.length > 0 ? `
                <div style="background: rgba(239,68,68,0.1); border: 1px solid var(--red); border-radius: 8px; padding: 0.75rem; margin-bottom: 1rem;">
                    <h4 style="color: var(--red); margin: 0 0 0.5rem 0; font-size: 0.85rem;">‚ö†Ô∏è Missing Information</h4>
                    <p style="color: #fca5a5; margin: 0; font-size: 0.8rem;">${data.missingFields.join(' ‚Ä¢ ')}</p>
                </div>
                ` : ''}
                
                <div class="quote-section">
                    <h4 style="color: var(--green); margin: 0 0 0.75rem 0; font-size: 0.85rem;">üì¶ Parsed Line Items</h4>
                    <table class="quote-items-table">
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th>Qty</th>
                                <th>Type</th>
                                <th>Est. Unit Price</th>
                                <th>Suggested Product</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.lineItems.length > 0 
                                ? data.lineItems.map(item => `
                                    <tr>
                                        <td style="color: #ccc;">${item.description}</td>
                                        <td style="color: #ccc;">${item.quantity}</td>
                                        <td><span class="quote-type-badge ${item.classKey}">${item.classification}</span></td>
                                        <td style="color: var(--green);">${item.suggestedProduct ? '$' + item.suggestedProduct.price.toLocaleString() : '--'}</td>
                                        <td style="color: var(--gray); font-size: 0.7rem;">${item.suggestedProduct ? item.suggestedProduct.name : 'Manual lookup required'}</td>
                                    </tr>
                                `).join('')
                                : '<tr><td colspan="5" style="text-align: center; color: var(--gray); padding: 1rem;">No items parsed - manual entry required</td></tr>'
                            }
                        </tbody>
                    </table>
                    ${data.estimatedMaterialCost > 0 ? `
                        <div style="margin-top: 0.75rem; padding: 0.5rem; background: rgba(154,205,50,0.1); border: 1px solid var(--green); border-radius: 4px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-size: 0.75rem; color: var(--gray);">üí∞ Estimated Material Cost:</span>
                                <span style="font-size: 1rem; font-weight: 700; color: var(--green);">$${data.estimatedMaterialCost.toLocaleString()}</span>
                            </div>
                            <div style="font-size: 0.65rem; color: var(--gray); margin-top: 0.25rem;">
                                Based on Singh catalog pricing. Actual costs may vary by quantity and lead time.
                            </div>
                        </div>
                    ` : ''}
                </div>
                
                <div class="quote-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                        <h4 style="color: var(--green); margin: 0; font-size: 0.85rem;">üìù Draft RFQ (Editable)</h4>
                        <button class="btn btn-sm btn-secondary" onclick="copyQuoteRFQ()">üìã Copy</button>
                    </div>
                    <textarea id="quoteRfqText" style="width: 100%; height: 300px; background: #0a0a0a; border: 1px solid var(--border); border-radius: 4px; color: #ccc; font-family: monospace; font-size: 0.75rem; padding: 1rem; resize: vertical;">${rfqDraft}</textarea>
                </div>
            </div>
            
            <div class="quote-modal-footer">
                <p style="color: var(--gray); font-size: 0.65rem; margin: 0; max-width: 55%;">
                    This request is for pre-award pricing validation only. No purchase authorization is implied. Pricing subject to change and government award.
                </p>
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn btn-secondary" onclick="closeQuoteModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="downloadQuoteRFQ()">üì• Download Draft</button>
                </div>
            </div>
        </div>
    `;
    
    modal.onclick = (e) => { if (e.target === modal) closeQuoteModal(); };
    document.body.appendChild(modal);
}

function generateRFQDraft(o, data) {
    const today = new Date().toISOString().split('T')[0];
    const distItems = data.lineItems.filter(i => i.classification === 'Distributor-sourcable');
    
    return `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           DISTRIBUTOR RFQ REQUEST - DRAFT
              ‚ö†Ô∏è FOR PRICING VALIDATION ONLY ‚ö†Ô∏è
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üìã REQUEST INFORMATION
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Request Date:        ${today}
Request Type:        Pre-Award Pricing Validation
Status:              DRAFT - PENDING HUMAN APPROVAL

‚ö†Ô∏è IMPORTANT NOTICE:
This request is for pricing validation only.
No purchase order is authorized.
Pricing subject to government award.

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üì¶ OPPORTUNITY DETAILS
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Opportunity ID:      ${o.solicitation || o.noticeId || 'Not specified'}
Title:               ${(o.title || '').substring(0, 80)}
Agency:              ${o.agency || 'Not specified'}
Response Due:        ${o.closeDate ? fmtDate(o.closeDate) : 'Not specified'}
Delivery Location:   ${o.placeOfPerformance || o.location || 'Not specified'}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üì¶ IDENTIFIED LINE ITEMS
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
${data.lineItems.length > 0 
    ? data.lineItems.map((item, i) => `
Item ${i + 1}: ${item.description}
  Quantity:     ${item.quantity}
  Type:         ${item.classification}
`).join('') 
    : '  No specific items identified - manual review required\n'}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üìù QUOTE REQUEST TERMS
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚Ä¢ Pricing valid for: 30 days from quote date
‚Ä¢ Payment terms: Net 30 (subject to government flow-down)
‚Ä¢ Shipping: FOB Destination
‚Ä¢ Lead time: Please specify for each item

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üè¢ REQUESTOR INFORMATION
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Company:         Singh Automation
CAGE Code:       86VF7
UEI:             GJ1DPYQ3X8K5
Contact:         Gurdeep Singh
Phone:           (269) 779-2179
Email:           g@singhus.com

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
‚ö†Ô∏è REQUIRED FOOTER - DO NOT REMOVE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
This request is for pre-award pricing validation only. 
No purchase authorization is implied. 
Pricing subject to change and government award.
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`;
}

function closeQuoteModal() {
    const modal = document.getElementById('quoteRequestModal');
    if (modal) modal.remove();
}

function copyQuoteRFQ() {
    const textarea = document.getElementById('quoteRfqText');
    if (textarea) {
        textarea.select();
        document.execCommand('copy');
        alert('RFQ draft copied to clipboard!');
    }
}

function downloadQuoteRFQ() {
    const textarea = document.getElementById('quoteRfqText');
    if (!textarea) return;
    
    const content = textarea.value;
    const blob = new Blob([content], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `RFQ_Draft_${new Date().toISOString().split('T')[0]}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    log('RFQ draft downloaded', 'success');
}
</script>
</body>
</html>
